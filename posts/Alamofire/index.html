<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Alamofire" /><meta name="author" content="dirtmelon" /><meta property="og:locale" content="en_US" /><meta name="description" content="为什么需要一个第三方框架 对于大部分 App 来说都需要跟服务器做数据传输，通常情况下都是通过 HTTPS/HTTP 来完成。 URLSession 已经封装得很好，但是如果需要把网络层跟业务层分离开来，我们通常需要基于 URLSession 再做一层封装，对 method ，header ，上传，下载，错误处理等再做一层处理，让业务方在调用的时候更加舒服。 Alamofire 是基于 URLSession 进行的封装，使用 Swift 编写的一个优雅的网络框架。本文主要是讲述 Alamofire 的具体逻辑和用法，对应的 Alamofire 版本为 5.2.1 。" /><meta property="og:description" content="为什么需要一个第三方框架 对于大部分 App 来说都需要跟服务器做数据传输，通常情况下都是通过 HTTPS/HTTP 来完成。 URLSession 已经封装得很好，但是如果需要把网络层跟业务层分离开来，我们通常需要基于 URLSession 再做一层封装，对 method ，header ，上传，下载，错误处理等再做一层处理，让业务方在调用的时候更加舒服。 Alamofire 是基于 URLSession 进行的封装，使用 Swift 编写的一个优雅的网络框架。本文主要是讲述 Alamofire 的具体逻辑和用法，对应的 Alamofire 版本为 5.2.1 。" /><link rel="canonical" href="https://dirtmelon.github.io/posts/Alamofire/" /><meta property="og:url" content="https://dirtmelon.github.io/posts/Alamofire/" /><meta property="og:site_name" content="Dirtmelon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-06-15T22:10:26+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Alamofire" /><meta name="twitter:site" content="@Dirt_melon" /><meta name="twitter:creator" content="@dirtmelon" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"dirtmelon"},"description":"为什么需要一个第三方框架 对于大部分 App 来说都需要跟服务器做数据传输，通常情况下都是通过 HTTPS/HTTP 来完成。 URLSession 已经封装得很好，但是如果需要把网络层跟业务层分离开来，我们通常需要基于 URLSession 再做一层封装，对 method ，header ，上传，下载，错误处理等再做一层处理，让业务方在调用的时候更加舒服。 Alamofire 是基于 URLSession 进行的封装，使用 Swift 编写的一个优雅的网络框架。本文主要是讲述 Alamofire 的具体逻辑和用法，对应的 Alamofire 版本为 5.2.1 。","url":"https://dirtmelon.github.io/posts/Alamofire/","headline":"Alamofire","dateModified":"2020-06-15T22:10:26+08:00","datePublished":"2020-06-15T22:10:26+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://dirtmelon.github.io/posts/Alamofire/"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>Alamofire | Dirtmelon</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Dirtmelon"><meta name="application-name" content="Dirtmelon"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/apple-icon.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dirtmelon</a></div><div class="site-subtitle font-italic">Dirtmelon's blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/dirtmelon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/Dirt_melon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['0xffdirtmelon','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Alamofire</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Alamofire</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> dirtmelon </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 15, 2020, 10:10 PM +0800" prep="on" > Jun 15, 2020 <i class="unloaded">2020-06-15T22:10:26+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="12143 words">67 min</span></div></div><div class="post-content"><h2 id="为什么需要一个第三方框架">为什么需要一个第三方框架</h2><p>对于大部分 App 来说都需要跟服务器做数据传输，通常情况下都是通过 HTTPS/HTTP 来完成。 <code class="language-plaintext highlighter-rouge">URLSession</code> 已经封装得很好，但是如果需要把网络层跟业务层分离开来，我们通常需要基于 <code class="language-plaintext highlighter-rouge">URLSession</code> 再做一层封装，对 method ，header ，上传，下载，错误处理等再做一层处理，让业务方在调用的时候更加舒服。 Alamofire 是基于 <code class="language-plaintext highlighter-rouge">URLSession</code> 进行的封装，使用 Swift 编写的一个优雅的网络框架。本文主要是讲述 Alamofire 的具体逻辑和用法，对应的 Alamofire 版本为 5.2.1 。</p><h2 id="urlsession-和-alamofire-比较">URLSession 和 Alamofire 比较</h2><p>举一个简单例子来说明下 <code class="language-plaintext highlighter-rouge">URLSession</code> 和 Alamofire 是如何发起请求的。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// URLSession</span>
<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span>
<span class="k">let</span> <span class="nv">dataTask</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="err">“</span><span class="nv">https</span><span class="p">:</span><span class="c1">//www.github.com”)!) { (data, response, error) in</span>
  <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
    <span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="nf">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">dataTask</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>

<span class="c1">// Alamofire</span>
<span class="kt">AF</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="err">“</span><span class="nv">https</span><span class="p">:</span><span class="c1">//www.github.com”)</span>
  <span class="o">.</span><span class="n">responseString</span> <span class="p">{</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">value</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>可以看到 Alamofire 简洁之处，不再需要手动创建 <code class="language-plaintext highlighter-rouge">URLSessionDataTask</code> 和调用 <code class="language-plaintext highlighter-rouge">resume</code> ，也不需要自己对请求结果进行解码和格式转换。网络请求都需要进行错误处理，参数转换和结果处理，而 Alamofire 都为我们提供了一系列链式调用的处理方法，代码也更容易理解和统一。</p><h2 id="整体架构">整体架构</h2><p>Alamofire 基本的整体架构如下图所示：</p><p><img data-proofer-ignore data-src="/media/Alamofire.png" alt="Alamofire" /></p><p><code class="language-plaintext highlighter-rouge">Alamofire</code> 项目结构非常简单清晰，<code class="language-plaintext highlighter-rouge">Alamofire.swift</code> 只提供一个 <code class="language-plaintext highlighter-rouge">AF</code> 单例：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="k">let</span> <span class="nv">AF</span> <span class="o">=</span> <span class="kt">Session</span><span class="o">.</span><span class="k">default</span>
</pre></table></code></div></div><p>跟 4.0 版本比起来的好处就是不会污染全局的命名空间，且如果 <code class="language-plaintext highlighter-rouge">Session</code> 添加了新的接口， <code class="language-plaintext highlighter-rouge">Alamofire.swift</code> 文件也不需要作出改动。</p><div lang="shell" class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="nt">--</span> Alamofire.swift
	<span class="nt">--</span> Core
		<span class="nt">--</span> AFError.swift
		<span class="nt">--</span> HTTPHeaders.swift
		<span class="nt">--</span> HTTPMethod.swift
		<span class="nt">--</span> Notifications.swift
		<span class="nt">--</span> ParameterEncoder.swift
		<span class="nt">--</span> ParameterEncoding.swift
		<span class="nt">--</span> Protected.swift
		<span class="nt">--</span> Request.swift
		<span class="nt">--</span> RequestTaskMap.swift
		<span class="nt">--</span> Response.swift
		<span class="nt">--</span> Session.swift
		<span class="nt">--</span> SessionDelegate.swift
		<span class="nt">--</span> URLConvertible+URLRequestConvertible.swift
	<span class="nt">--</span> Extensions
		<span class="nt">--</span> DispatchQueue+Alamofire.swift
		<span class="nt">--</span> OperationQueue+Alamofire.swift
		<span class="nt">--</span> Result+Alamofire.swift
		<span class="nt">--</span> StringEncoding+Alamofire.swift
		<span class="nt">--</span> URLRequest+Alamofire.swift
		<span class="nt">--</span> URLSessionConfiguration+Alamofire.swift
	<span class="nt">--</span> Features
		<span class="nt">--</span> AlamofireExtended.swift
		<span class="nt">--</span> AuthenticationInterceptor.swift
		<span class="nt">--</span> CachedResponseHandler.swift
		<span class="nt">--</span> Combine.swift
		<span class="nt">--</span> EventMonitor.swift
		<span class="nt">--</span> MultipartFormData.swift
		<span class="nt">--</span> MultipartUpload.swift
		<span class="nt">--</span> NetworkReachabilityManager.swift
		<span class="nt">--</span> RedirectHandler.swift
		<span class="nt">--</span> RequestInterceptor.swift
		<span class="nt">--</span> ResponseSerialization.swift
		<span class="nt">--</span> RetryPolicy.swift
		<span class="nt">--</span> ServerTrustEvaluation.swift
		<span class="nt">--</span> URLEncodedFormEncoder.swift
		<span class="nt">--</span> Validation.swift
</pre></table></code></div></div><ol><li><code class="language-plaintext highlighter-rouge">Core</code> 里面包含的是网络请求过程中必须要调用的部分；<li><code class="language-plaintext highlighter-rouge">Extensions</code> 为系统的一些类添加了便捷方法；<li><code class="language-plaintext highlighter-rouge">Features</code> 则是 <code class="language-plaintext highlighter-rouge">Alamofire</code> 提供的一些特定功能，如缓存策略，重试策略，请求结果的处理等；</ol><h2 id="基础解析">基础解析</h2><p>为了在熟悉整个请求流程时各个参数，协议的作用，先来熟悉一下请求流程中都有使用到哪些类，协议或者方法。</p><h3 id="aferror">AFError</h3><p>请求错误时的 <code class="language-plaintext highlighter-rouge">enum</code> 类型，因为网络请求错误的类型较多，所以分了两层，第一层是 <code class="language-plaintext highlighter-rouge">AFError</code> ，而每个 <code class="language-plaintext highlighter-rouge">error</code> 也有可能会因应自己的二级分类再定义一个 <code class="language-plaintext highlighter-rouge">enum</code> 类型，下面是二级 <code class="language-plaintext highlighter-rouge">enum</code> 类型：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kt">MultipartEncodingFailureReason</span> <span class="c1">// 表单转码错误</span>
<span class="kt">ParameterEncodingFailureReason</span> <span class="c1">// 参数转码错误</span>
<span class="kt">ParameterEncoderFailureReason</span> <span class="c1">// 参数转码器错误</span>
  <span class="o">-</span> <span class="kt">RequiredComponent</span> <span class="c1">// 缺少必要的组件</span>
<span class="kt">ResponseValidationFailureReason</span> <span class="c1">// 响应数据验证错误</span>
<span class="kt">ResponseSerializationFailureReason</span> <span class="c1">// 响应数据序列化错误</span>
<span class="kt">ServerTrustFailureReason</span> <span class="c1">// 服务器验证错误</span>
<span class="kt">URLRequestValidationFailureReason</span> <span class="c1">// 请求验证错误</span>
</pre></table></code></div></div><p>除此之外，Alamofire 也提供了不少扩展方法给 <code class="language-plaintext highlighter-rouge">Error</code>和 <code class="language-plaintext highlighter-rouge">AFError</code> 使用，以求在使用上更便捷。如 <code class="language-plaintext highlighter-rouge">Error</code> 可以转化为 <code class="language-plaintext highlighter-rouge">AFError</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">Error</span> <span class="p">{</span>
    <span class="c1">/// Returns the instance cast as an `AFError`.</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">asAFError</span><span class="p">:</span> <span class="kt">AFError</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">self</span> <span class="k">as?</span> <span class="kt">AFError</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">asAFError</span><span class="p">(</span><span class="n">orFailWith</span> <span class="nv">message</span><span class="p">:</span> <span class="kd">@autoclosure</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">file</span><span class="p">:</span> <span class="kt">StaticString</span> <span class="o">=</span> <span class="kd">#file</span><span class="p">,</span> <span class="nv">line</span><span class="p">:</span> <span class="kt">UInt</span> <span class="o">=</span> <span class="kd">#line</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AFError</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">afError</span> <span class="o">=</span> <span class="k">self</span> <span class="k">as?</span> <span class="kt">AFError</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">fatalError</span><span class="p">(</span><span class="nf">message</span><span class="p">(),</span> <span class="nv">file</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="nv">line</span><span class="p">:</span> <span class="n">line</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">afError</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">asAFError</span><span class="p">(</span><span class="n">or</span> <span class="n">defaultAFError</span><span class="p">:</span> <span class="kd">@autoclosure</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AFError</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AFError</span> <span class="p">{</span>
        <span class="k">self</span> <span class="k">as?</span> <span class="kt">AFError</span> <span class="p">??</span> <span class="nf">defaultAFError</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这里使用了 <code class="language-plaintext highlighter-rouge">@autoclosure</code> 来声明对应的 <code class="language-plaintext highlighter-rouge">Closure</code> 。</p><ol><li>使用闭包是为了利用其延迟执行的特性，如果 <code class="language-plaintext highlighter-rouge">Error</code> 其实是个 <code class="language-plaintext highlighter-rouge">AFError</code> ，那么我们就不需要获取 <code class="language-plaintext highlighter-rouge">defaultAFError</code> ，也不需要执行对应的代码，所以这里使用了闭包来传参。<li>使用 <code class="language-plaintext highlighter-rouge">@autoclosure</code> 进行声明，这样调用方在调用的时候不需要加上 <code class="language-plaintext highlighter-rouge">{}</code> ，看起来跟普通的参数一样：</ol><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">error</span><span class="o">.</span><span class="nf">asAFError</span><span class="p">(</span><span class="nv">or</span><span class="p">:</span> <span class="o">.</span><span class="nf">responseSerializationFailed</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="o">.</span><span class="nf">customSerializationFailed</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">)))</span>
</pre></table></code></div></div><h3 id="httpheaders">HTTPHeaders</h3><p><code class="language-plaintext highlighter-rouge">HTTPHeaders</code> 是一个 <code class="language-plaintext highlighter-rouge">Struct</code> 类型，保存了 HTTP 头的一些 name / value 配对。 <code class="language-plaintext highlighter-rouge">HTTPHeader</code> 则封装了一些快速生成 HTTP 头属性的方法。你可以使用 <code class="language-plaintext highlighter-rouge">URLSessionConfiguration.af.default</code> 来获取默认的 <code class="language-plaintext highlighter-rouge">HTTPHeaders</code> 对应的 <code class="language-plaintext highlighter-rouge">URLSessionConfiguration</code> 。 为了方便直接生成 <code class="language-plaintext highlighter-rouge">HTTPHeaders</code> ， 还支持 <code class="language-plaintext highlighter-rouge">ExpressibleByDictionaryLiteral</code> 和 <code class="language-plaintext highlighter-rouge">ExpressibleByArrayLiteral</code> 协议，可以直接使用 <code class="language-plaintext highlighter-rouge">Dictionary</code> 和 <code class="language-plaintext highlighter-rouge">Array</code> 的 字面表达式来直接生成：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">HTTPHeaders</span><span class="p">:</span> <span class="kt">ExpressibleByDictionaryLiteral</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">dictionaryLiteral</span> <span class="nv">elements</span><span class="p">:</span> <span class="p">(</span><span class="kt">String</span><span class="p">,</span> <span class="kt">String</span><span class="p">)</span><span class="err">…</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>

        <span class="n">elements</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="nf">update</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="nv">$0</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="nv">$0</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">HTTPHeaders</span><span class="p">:</span> <span class="kt">ExpressibleByArrayLiteral</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">arrayLiteral</span> <span class="nv">elements</span><span class="p">:</span> <span class="kt">HTTPHeader</span><span class="err">…</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 这里的 .authorization 和 .accpet 都是 HTTPHeader 中为了方便我们调用提供的初始化方法。</span>
<span class="k">let</span> <span class="nv">headers</span><span class="p">:</span> <span class="kt">HTTPHeaders</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">.</span><span class="nf">authorization</span><span class="p">(</span><span class="nv">username</span><span class="p">:</span> <span class="s">"Username”, password: “Password"</span><span class="p">),</span>
    <span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="err">“</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="err">”</span><span class="p">)</span>
<span class="p">]</span>
</pre></table></code></div></div><p>对于一些系统的类，也提供了便捷方法来获取 <code class="language-plaintext highlighter-rouge">HTTPHeaders</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">URLRequest</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">headers</span><span class="p">:</span> <span class="kt">HTTPHeaders</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="n">allHTTPHeaderFields</span><span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">HTTPHeaders</span><span class="o">.</span><span class="kd">init</span><span class="p">)</span> <span class="p">??</span> <span class="kt">HTTPHeaders</span><span class="p">()</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="n">allHTTPHeaderFields</span> <span class="o">=</span> <span class="n">newValue</span><span class="o">.</span><span class="n">dictionary</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">HTTPURLResponse</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">headers</span><span class="p">:</span> <span class="kt">HTTPHeaders</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">allHeaderFields</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span><span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">HTTPHeaders</span><span class="o">.</span><span class="kd">init</span><span class="p">)</span> <span class="p">??</span> <span class="kt">HTTPHeaders</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">extension</span> <span class="kt">URLSessionConfiguration</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">headers</span><span class="p">:</span> <span class="kt">HTTPHeaders</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="p">(</span><span class="n">httpAdditionalHeaders</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span><span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">HTTPHeaders</span><span class="o">.</span><span class="kd">init</span><span class="p">)</span> <span class="p">??</span> <span class="kt">HTTPHeaders</span><span class="p">()</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="n">httpAdditionalHeaders</span> <span class="o">=</span> <span class="n">newValue</span><span class="o">.</span><span class="n">dictionary</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>可以看到通过 <code class="language-plaintext highlighter-rouge">HTTPHeaders</code> 和 <code class="language-plaintext highlighter-rouge">HTTPHeader</code> ，在设定 HTTP 头时我们不再需要进行字符串的 hardcode ，通过 <code class="language-plaintext highlighter-rouge">ExpressibleByDictionaryLiteral</code> 和 <code class="language-plaintext highlighter-rouge">ExpressibleByArrayLiteral</code> 这两个协议也可以很舒服地设置相关的属性。</p><h3 id="notifications">Notifications</h3><p><code class="language-plaintext highlighter-rouge">Notifications.swift</code> 的结构分为几部分。 第一部分是 <code class="language-plaintext highlighter-rouge">Request</code> 的扩展，定义了请求相关的通知，通过 <code class="language-plaintext highlighter-rouge">static let</code> 定义相关通知，方便调用：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">extension</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">didResumeNotification</span> <span class="o">=</span> <span class="kt">Notification</span><span class="o">.</span><span class="kt">Name</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="err">“</span><span class="n">org</span><span class="o">.</span><span class="n">alamofire</span><span class="o">.</span><span class="n">notification</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">didResume</span><span class="err">”</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 调用</span>
<span class="kt">Request</span><span class="o">.</span><span class="n">didResumeNotification</span>
</pre></table></code></div></div><p>第二部分是 <code class="language-plaintext highlighter-rouge">Notification</code> 和 <code class="language-plaintext highlighter-rouge">NotificationCenter</code> 的扩展，方便与 <code class="language-plaintext highlighter-rouge">Request</code> 进行交互：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">Notification</span> <span class="p">{</span>
    <span class="c1">/// 把userInfo 的 Request 通过 String.requestKey 封装起来，方便获取</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">userInfo</span><span class="p">?[</span><span class="kt">String</span><span class="o">.</span><span class="n">requestKey</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">Request</span>
    <span class="p">}</span>

    <span class="c1">/// 通过 Request 和 NotificationName 生成 Notification ，不需要每次都手动设置 userInfo</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">Notification</span><span class="o">.</span><span class="kt">Name</span><span class="p">,</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="nv">object</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">userInfo</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="o">.</span><span class="nv">requestKey</span><span class="p">:</span> <span class="n">request</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>第三部分定义了一个 <code class="language-plaintext highlighter-rouge">AlamofireNotifications</code> 类，遵循 <code class="language-plaintext highlighter-rouge">EventMonitor</code>协议，这个类的作用下面会说到，通过 <code class="language-plaintext highlighter-rouge">AlamofireNotifications</code> 我们可以在需要的地方添加 <code class="language-plaintext highlighter-rouge">Request</code> 的相关通知，灵活地实现对应的方法，不需要统一配置，而发送通知的时机也嵌入到 <code class="language-plaintext highlighter-rouge">EventMonitor</code> 的逻辑中，不需要额外处理：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="c1">/// `EventMonitor` that provides Alamofire’s notifications.</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">AlamofireNotifications</span><span class="p">:</span> <span class="kt">EventMonitor</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">requestDidResume</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">postNotification</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="n">didResumeNotification</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">requestDidSuspend</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">postNotification</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="n">didSuspendNotification</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">requestDidCancel</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">postNotification</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="n">didCancelNotification</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">requestDidFinish</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">postNotification</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="n">didFinishNotification</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="n">didResumeTask</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">postNotification</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="n">didResumeTaskNotification</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="n">didSuspendTask</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">postNotification</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="n">didSuspendTaskNotification</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="n">didCancelTask</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">postNotification</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="n">didCancelTaskNotification</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="n">didCompleteTask</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">with</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">AFError</span><span class="p">?)</span> <span class="p">{</span>
        <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">postNotification</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="n">didCompleteTaskNotification</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="parameterencoder">ParameterEncoder</h3><p><code class="language-plaintext highlighter-rouge">ParameterEncoder</code> 协议，一个参数编码器，用来编码支持 <code class="language-plaintext highlighter-rouge">Encodable</code> 协议类型到 <code class="language-plaintext highlighter-rouge">URLRequest</code> 中，只需要实现一个方法用于处理 <code class="language-plaintext highlighter-rouge">parameters</code> 并生成对应的 <code class="language-plaintext highlighter-rouge">URLRequest</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="n">encode</span><span class="o">&lt;</span><span class="kt">Parameters</span><span class="p">:</span> <span class="kt">Encodable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span><span class="p">?,</span> <span class="n">into</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">JSONParameterEncoder</code> 用于 <code class="language-plaintext highlighter-rouge">JSON</code> 的编码，如果 <code class="language-plaintext highlighter-rouge">URLRequest</code> 的请求头没有设置 <code class="language-plaintext highlighter-rouge">Content-Type</code> ，它就会设置为 <code class="language-plaintext highlighter-rouge">application/json</code> 。 <code class="language-plaintext highlighter-rouge">JSONParameterEncoder</code> 只支持对 <code class="language-plaintext highlighter-rouge">URLRequest</code> 的 <code class="language-plaintext highlighter-rouge">httpBody</code> 属性进行设置：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">open</span> <span class="kd">func</span> <span class="n">encode</span><span class="o">&lt;</span><span class="kt">Parameters</span><span class="p">:</span> <span class="kt">Encodable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span><span class="p">?,</span>
                                        <span class="n">into</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">request</span> <span class="p">}</span>

    <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="n">request</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="n">encoder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">httpBody</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"Content-Type"</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="o">.</span><span class="nf">contentType</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">AFError</span><span class="o">.</span><span class="nf">parameterEncodingFailed</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="o">.</span><span class="nf">jsonEncodingFailed</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">request</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">URLEncodedFormParameterEncoder</code> 用于生成 <code class="language-plaintext highlighter-rouge">URL</code> 编码方式的字符串，与 <code class="language-plaintext highlighter-rouge">JSONParameterEncoder</code> 不同，可以追加到 URL 后面，也可以设置到 body 中，取决于 <code class="language-plaintext highlighter-rouge">Destination</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">Destination</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">methodDependent</span> <span class="c1">// 如果是 .get， .head 和 .delete 方法则追加到 URL 链接后面，否则设置为 httpBody</span>
  <span class="k">case</span> <span class="n">methodDependent</span> <span class="c1">// 全都追加到 URL 链接后面</span>
  <span class="k">case</span> <span class="n">httpBody</span> <span class="c1">// 全都设置为 httpBody </span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">URLEncodedFormParameterEncoder</code> 的 <code class="language-plaintext highlighter-rouge">encoder</code> 属性是 <code class="language-plaintext highlighter-rouge">URLEncodedFormEncoder</code> 类型，用于编码时各种类型的转换。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">open</span> <span class="kd">func</span> <span class="n">encode</span><span class="o">&lt;</span><span class="kt">Parameters</span><span class="p">:</span> <span class="kt">Encodable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span><span class="p">?,</span>
                                        <span class="n">into</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">request</span> <span class="p">}</span>

    <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="n">request</span>
	  <span class="c1">// 1.</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">AFError</span><span class="o">.</span><span class="nf">parameterEncoderFailed</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="o">.</span><span class="nf">missingRequiredComponent</span><span class="p">(</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="c1">// 2.</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">rawValue</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">?</span><span class="o">.</span><span class="n">rawValue</span> <span class="p">??</span> <span class="s">"nil"</span>
        <span class="k">throw</span> <span class="kt">AFError</span><span class="o">.</span><span class="nf">parameterEncoderFailed</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="o">.</span><span class="nf">missingRequiredComponent</span><span class="p">(</span><span class="o">.</span><span class="nf">httpMethod</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">rawValue</span><span class="p">)))</span>
    <span class="p">}</span>
    <span class="c1">// 3.</span>
    <span class="k">if</span> <span class="n">destination</span><span class="o">.</span><span class="nf">encodesParametersInURL</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">method</span><span class="p">),</span>
        <span class="k">var</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 4.</span>
        <span class="k">let</span> <span class="nv">query</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">try</span> <span class="n">encoder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="p">}</span>
            <span class="o">.</span><span class="n">mapError</span> <span class="p">{</span> <span class="kt">AFError</span><span class="o">.</span><span class="nf">parameterEncoderFailed</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="o">.</span><span class="nf">encoderFailed</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="nv">$0</span><span class="p">))</span> <span class="p">}</span><span class="o">.</span><span class="nf">get</span><span class="p">()</span>
        <span class="k">let</span> <span class="nv">newQueryString</span> <span class="o">=</span> <span class="p">[</span><span class="n">components</span><span class="o">.</span><span class="n">percentEncodedQuery</span><span class="p">,</span> <span class="n">query</span><span class="p">]</span><span class="o">.</span><span class="n">compactMap</span> <span class="p">{</span> <span class="nv">$0</span> <span class="p">}</span><span class="o">.</span><span class="nf">joinedWithAmpersands</span><span class="p">()</span>
        <span class="n">components</span><span class="o">.</span><span class="n">percentEncodedQuery</span> <span class="o">=</span> <span class="n">newQueryString</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">?</span> <span class="nv">nil</span> <span class="p">:</span> <span class="n">newQueryString</span>

        <span class="k">guard</span> <span class="k">let</span> <span class="nv">newURL</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">AFError</span><span class="o">.</span><span class="nf">parameterEncoderFailed</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="o">.</span><span class="nf">missingRequiredComponent</span><span class="p">(</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">newURL</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 5.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"Content-Type"</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="o">.</span><span class="nf">contentType</span><span class="p">(</span><span class="s">"application/x-www-form-urlencoded; charset=utf-8"</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="n">request</span><span class="o">.</span><span class="n">httpBody</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">try</span> <span class="n">encoder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="p">}</span>
            <span class="o">.</span><span class="n">mapError</span> <span class="p">{</span> <span class="kt">AFError</span><span class="o">.</span><span class="nf">parameterEncoderFailed</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="o">.</span><span class="nf">encoderFailed</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="nv">$0</span><span class="p">))</span> <span class="p">}</span><span class="o">.</span><span class="nf">get</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">request</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>判断 <code class="language-plaintext highlighter-rouge">request</code> 是否有 <code class="language-plaintext highlighter-rouge">url</code> ，如果没有则报 <code class="language-plaintext highlighter-rouge">AFError.parameterEncoderFailed(reason: .missingRequiredComponent(.httpMethod(rawValue: rawValue)))</code> 错误；<li>判断 <code class="language-plaintext highlighter-rouge">request</code> 是否有指定 <code class="language-plaintext highlighter-rouge">method</code> ，如果没有则报 <code class="language-plaintext highlighter-rouge">AFError.parameterEncoderFailed(reason: .missingRequiredComponent(.httpMethod(rawValue: rawValue)))</code> 错误；<li>判断参数编码后是否追加到 <code class="language-plaintext highlighter-rouge">url</code> 中；<li><code class="language-plaintext highlighter-rouge">mapError</code> 用于转换 <code class="language-plaintext highlighter-rouge">Result</code> 为 <code class="language-plaintext highlighter-rouge">failure</code> 时的 <code class="language-plaintext highlighter-rouge">error</code> ，<code class="language-plaintext highlighter-rouge">get()</code> 可以获取 <code class="language-plaintext highlighter-rouge">success value</code> ；<li>参数编码后设置为 <code class="language-plaintext highlighter-rouge">httpBody</code> ；</ol><h3 id="parameterencoding">ParameterEncoding</h3><p><code class="language-plaintext highlighter-rouge">ParameterEncoding</code> 协议，跟 <code class="language-plaintext highlighter-rouge">ParameterEncoder</code> 协议的不同之处在于参数不再需要遵循 <code class="language-plaintext highlighter-rouge">Encodable</code> 协议，改为直接使用 <code class="language-plaintext highlighter-rouge">typealias Parameters = [String: Any]</code> ， 即 <code class="language-plaintext highlighter-rouge">key</code> 类型指定为 <code class="language-plaintext highlighter-rouge">String</code> 的 <code class="language-plaintext highlighter-rouge">Dictionary</code> 。 <code class="language-plaintext highlighter-rouge">ParameterEncoding</code> 的作用跟 <code class="language-plaintext highlighter-rouge">ParameterEncoder</code> 类似，这里不再赘述。</p><h3 id="protectedt"><code class="language-plaintext highlighter-rouge">Protected&lt;T&gt;</code></h3><p><code class="language-plaintext highlighter-rouge">Protected&lt;T&gt;</code> 支持范型，所以我们可以通过 <code class="language-plaintext highlighter-rouge">Protected&lt;T&gt;</code> 为各个类，结构体提供线程安全的封装，如同 <code class="language-plaintext highlighter-rouge">Protected&lt;T&gt;</code> 的说明。 为了实现线程安全，一般都需要一把锁， <code class="language-plaintext highlighter-rouge">Protected.swift</code> 里定义了一个 <code class="language-plaintext highlighter-rouge">private protocol Lock</code> ，这里对 <code class="language-plaintext highlighter-rouge">defer</code> 的使用也非常巧妙：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">protocol</span> <span class="kt">Lock</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">lock</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">unlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Lock</span> <span class="p">{</span>
    
    <span class="c1">// 执行有返回值的 closure</span>
    <span class="kd">func</span> <span class="n">around</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">closure</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">T</span> <span class="p">{</span>
        <span class="nf">lock</span><span class="p">();</span> <span class="k">defer</span> <span class="p">{</span> <span class="nf">unlock</span><span class="p">()</span> <span class="p">}</span>
        <span class="k">return</span> <span class="nf">closure</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">/// 执行无返回值的 closure</span>
    <span class="kd">func</span> <span class="nf">around</span><span class="p">(</span><span class="n">_</span> <span class="nv">closure</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">lock</span><span class="p">();</span> <span class="k">defer</span> <span class="p">{</span> <span class="nf">unlock</span><span class="p">()</span> <span class="p">}</span>
        <span class="nf">closure</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>遵循 <code class="language-plaintext highlighter-rouge">Lock</code> 协议需要提供两个方法， <code class="language-plaintext highlighter-rouge">lock()</code> 和 <code class="language-plaintext highlighter-rouge">unlock()</code> ，而在 <code class="language-plaintext highlighter-rouge">Lock</code> 的 <code class="language-plaintext highlighter-rouge">extension</code> 里面，提供了两个结合 <code class="language-plaintext highlighter-rouge">closure</code> 实现加锁的方法，这两个方法可以满足大部分需要加锁的操作需求。之所以将 <code class="language-plaintext highlighter-rouge">Lock</code> 抽离为协议，是因为 Alamofire 需要支持 Linux ，而 Linux 无法使用 <code class="language-plaintext highlighter-rouge">os_unfair_lock</code> ，只能使用 <code class="language-plaintext highlighter-rouge">pthread_mutex_t</code> 。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="cp">#if os(Linux)</span>
<span class="c1">/// 5.1 新增的 MutexLock ，是 pthread_mutex_t 的 wrapper ，为了支持 Linux 平台。</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">MutexLock</span><span class="p">:</span> <span class="kt">Lock</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">mutex</span><span class="p">:</span> <span class="kt">UnsafeMutablePointer</span><span class="o">&lt;</span><span class="n">pthread_mutex_t</span><span class="o">&gt;</span>

    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">mutex</span> <span class="o">=</span> <span class="o">.</span><span class="nf">allocate</span><span class="p">(</span><span class="nv">capacity</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">var</span> <span class="nv">attr</span> <span class="o">=</span> <span class="nf">pthread_mutexattr_t</span><span class="p">()</span>
        <span class="nf">pthread_mutexattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">)</span>
        <span class="nf">pthread_mutexattr_settype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="kt">PTHREAD_MUTEX_ERRORCHECK</span><span class="p">))</span>

        <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">)</span>
        <span class="nf">precondition</span><span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Failed to create pthread_mutex"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="nf">pthread_mutex_destroy</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
        <span class="nf">precondition</span><span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Failed to destroy pthread_mutex"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">fileprivate</span> <span class="kd">func</span> <span class="nf">lock</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
        <span class="nf">precondition</span><span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Failed to lock pthread_mutex"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">fileprivate</span> <span class="kd">func</span> <span class="nf">unlock</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
        <span class="nf">precondition</span><span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Failed to unlock pthread_mutex"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if os(macOS) || os(iOS) || os(watchOS) || os(tvOS)</span>
<span class="c1">/// 原有的 os_unfair_lock ，苹果平台使用。</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">UnfairLock</span><span class="p">:</span> <span class="kt">Lock</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">unfairLock</span><span class="p">:</span> <span class="n">os_unfair_lock_t</span>

    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">unfairLock</span> <span class="o">=</span> <span class="o">.</span><span class="nf">allocate</span><span class="p">(</span><span class="nv">capacity</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">unfairLock</span><span class="o">.</span><span class="nf">initialize</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="nf">os_unfair_lock</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="n">unfairLock</span><span class="o">.</span><span class="nf">deinitialize</span><span class="p">(</span><span class="nv">count</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">unfairLock</span><span class="o">.</span><span class="nf">deallocate</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">fileprivate</span> <span class="kd">func</span> <span class="nf">lock</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">os_unfair_lock_lock</span><span class="p">(</span><span class="n">unfairLock</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">fileprivate</span> <span class="kd">func</span> <span class="nf">unlock</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">os_unfair_lock_unlock</span><span class="p">(</span><span class="n">unfairLock</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</pre></table></code></div></div><p>在定义了 <code class="language-plaintext highlighter-rouge">Lock</code> 类之后，<code class="language-plaintext highlighter-rouge">Protected&lt;T&gt;</code> 就可以通过 <code class="language-plaintext highlighter-rouge">Lock</code> 来实现线程安全，这里使用了 <code class="language-plaintext highlighter-rouge">@propertyWrapper</code> 来进行声明。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="kd">@propertyWrapper</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">Protected</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="cp">#if os(macOS) || os(iOS) || os(watchOS) || os(tvOS)</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">lock</span> <span class="o">=</span> <span class="kt">UnfairLock</span><span class="p">()</span>
    <span class="cp">#elseif os(Linux)</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">lock</span> <span class="o">=</span> <span class="kt">MutexLock</span><span class="p">()</span>
    <span class="cp">#endif</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span>

    <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="p">}</span>

    <span class="c1">/// 访问 wrappedValue 时必须要加锁。</span>
    <span class="k">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="kt">T</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="n">lock</span><span class="o">.</span><span class="n">around</span> <span class="p">{</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="n">lock</span><span class="o">.</span><span class="n">around</span> <span class="p">{</span> <span class="n">value</span> <span class="o">=</span> <span class="n">newValue</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="nv">projectedValue</span><span class="p">:</span> <span class="kt">Protected</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">self</span> <span class="p">}</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">wrappedValue</span><span class="p">:</span> <span class="kt">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">wrappedValue</span>
    <span class="p">}</span>

    <span class="c1">/// 同步获取值或者进行转换</span>
    <span class="kd">func</span> <span class="n">read</span><span class="o">&lt;</span><span class="kt">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">closure</span><span class="p">:</span> <span class="p">(</span><span class="kt">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">U</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">U</span> <span class="p">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">around</span> <span class="p">{</span> <span class="nf">closure</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// 同步修改值，同时可以返回修改后的值。</span>
    <span class="kd">@discardableResult</span>
    <span class="kd">func</span> <span class="n">write</span><span class="o">&lt;</span><span class="kt">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">closure</span><span class="p">:</span> <span class="p">(</span><span class="k">inout</span> <span class="kt">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">U</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">U</span> <span class="p">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">around</span> <span class="p">{</span> <span class="nf">closure</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>

	  <span class="c1">/// 支持 @dynamicMemberLookup 后实现的方法，使得 Protected 声明的属性可以通过点语法来进行 keyPath 读写</span>
    <span class="kd">subscript</span><span class="o">&lt;</span><span class="kt">Property</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dynamicMember</span> <span class="nv">keyPath</span><span class="p">:</span> <span class="kt">WritableKeyPath</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">,</span> <span class="kt">Property</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Property</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="n">lock</span><span class="o">.</span><span class="n">around</span> <span class="p">{</span> <span class="n">value</span><span class="p">[</span><span class="nv">keyPath</span><span class="p">:</span> <span class="n">keyPath</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="n">lock</span><span class="o">.</span><span class="n">around</span> <span class="p">{</span> <span class="n">value</span><span class="p">[</span><span class="nv">keyPath</span><span class="p">:</span> <span class="n">keyPath</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>为了方便使用， <code class="language-plaintext highlighter-rouge">Protected</code> 又添加了几个扩展。 这部分是为 <code class="language-plaintext highlighter-rouge">T</code> 实现了 <code class="language-plaintext highlighter-rouge">RangeReplaceableCollection</code> 协议后支持的方法，都是集合的 <code class="language-plaintext highlighter-rouge">append</code> 方法：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">Protected</span> <span class="k">where</span> <span class="kt">T</span><span class="p">:</span> <span class="kt">RangeReplaceableCollection</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">append</span><span class="p">(</span><span class="n">_</span> <span class="nv">newElement</span><span class="p">:</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Element</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">write</span> <span class="p">{</span> <span class="p">(</span><span class="nv">ward</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">T</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">ward</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">newElement</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="n">append</span><span class="o">&lt;</span><span class="kt">S</span><span class="p">:</span> <span class="kt">Sequence</span><span class="o">&gt;</span><span class="p">(</span><span class="n">contentsOf</span> <span class="nv">newElements</span><span class="p">:</span> <span class="kt">S</span><span class="p">)</span> <span class="k">where</span> <span class="kt">S</span><span class="o">.</span><span class="kt">Element</span> <span class="o">==</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Element</span> <span class="p">{</span>
        <span class="n">write</span> <span class="p">{</span> <span class="p">(</span><span class="nv">ward</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">T</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">ward</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">newElements</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="n">append</span><span class="o">&lt;</span><span class="kt">C</span><span class="p">:</span> <span class="kt">Collection</span><span class="o">&gt;</span><span class="p">(</span><span class="n">contentsOf</span> <span class="nv">newElements</span><span class="p">:</span> <span class="kt">C</span><span class="p">)</span> <span class="k">where</span> <span class="kt">C</span><span class="o">.</span><span class="kt">Element</span> <span class="o">==</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Element</span> <span class="p">{</span>
        <span class="n">write</span> <span class="p">{</span> <span class="p">(</span><span class="nv">ward</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">T</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">ward</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">newElements</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">T</code> 为 <code class="language-plaintext highlighter-rouge">Data?</code> 类型时支持 <code class="language-plaintext highlighter-rouge">append</code> :</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">Protected</span> <span class="k">where</span> <span class="kt">T</span> <span class="o">==</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">append</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">write</span> <span class="p">{</span> <span class="p">(</span><span class="nv">ward</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">T</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">ward</span><span class="p">?</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">T</code> 为 <code class="language-plaintext highlighter-rouge">Request.MutableState</code> 时提供一些编辑方法，用于状态转换：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">Protected</span> <span class="k">where</span> <span class="kt">T</span> <span class="o">==</span> <span class="kt">Request</span><span class="o">.</span><span class="kt">MutableState</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">attemptToTransitionTo</span><span class="p">(</span><span class="n">_</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="kt">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">around</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="n">value</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="nf">canTransitionTo</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span> <span class="p">}</span>

            <span class="n">value</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>

            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">withState</span><span class="p">(</span><span class="nv">perform</span><span class="p">:</span> <span class="p">(</span><span class="kt">Request</span><span class="o">.</span><span class="kt">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">around</span> <span class="p">{</span> <span class="nf">perform</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">state</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="request">Request</h3><p><code class="language-plaintext highlighter-rouge">Request</code> 是 Alamofire 中对应每个网络请求的父类，每次发起网络请求都会生成一个对应的子类对象，根据不同的网络请求会生成 <code class="language-plaintext highlighter-rouge">DataRequest</code> ，<code class="language-plaintext highlighter-rouge">DataStreamRequest</code> ， <code class="language-plaintext highlighter-rouge">DownloadRequest</code> 和 <code class="language-plaintext highlighter-rouge">UploadRequest</code> 。调用方不需要直接生成 <code class="language-plaintext highlighter-rouge">Request</code> 对象， <code class="language-plaintext highlighter-rouge">Request</code> 对象由 <code class="language-plaintext highlighter-rouge">Session</code> 负责生成。</p><p><code class="language-plaintext highlighter-rouge">Request</code> 状态机：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c1">// 当 Request 调用 resume() ， suspend() 或者 cancel() 方法时，处理状态之间的转换。</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="kt">State</span> <span class="p">{</span>
    <span class="c1">/// 初始化状态</span>
    <span class="k">case</span> <span class="n">initialized</span>
    <span class="c1">/// 当调用 resume() 时就会切换为 resumed 状态，同时也会调用对应的 task 的 resume() 方法</span>
    <span class="k">case</span> <span class="n">resumed</span>
    <span class="c1">/// 当调用 suspend() 时就会切换为 suspended 状态，同时也会调用对应的 task 的 suspend() 方法</span>
    <span class="k">case</span> <span class="n">suspended</span>
    <span class="c1">/// 当调用 cancel() 时就会切换为 cancelled 状态，同时也会调用对应的 task 的 cancel() 方法</span>
    <span class="c1">/// 跟 resumed 和 suspended 状态不同，转换至 cancelled 状态后无法再转换至其它状态</span>
    <span class="k">case</span> <span class="n">cancelled</span>
    <span class="c1">/// 完成所有请求结果的序列化操作</span>
    <span class="k">case</span> <span class="n">finished</span>

    <span class="c1">/// 判断当前状态是否可以转换到其它状态</span>
    <span class="kd">func</span> <span class="nf">canTransitionTo</span><span class="p">(</span><span class="n">_</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">(</span><span class="o">.</span><span class="n">initialized</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="o">.</span><span class="n">initialized</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="n">cancelled</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="n">finished</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="k">case</span> <span class="p">(</span><span class="o">.</span><span class="n">resumed</span><span class="p">,</span> <span class="o">.</span><span class="n">cancelled</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="n">suspended</span><span class="p">,</span> <span class="o">.</span><span class="n">cancelled</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="n">resumed</span><span class="p">,</span> <span class="o">.</span><span class="n">suspended</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="n">suspended</span><span class="p">,</span> <span class="o">.</span><span class="n">resumed</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="k">case</span> <span class="p">(</span><span class="o">.</span><span class="n">suspended</span><span class="p">,</span> <span class="o">.</span><span class="n">suspended</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="n">resumed</span><span class="p">,</span> <span class="o">.</span><span class="n">resumed</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="o">.</span><span class="n">finished</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>状态机转换图如下：</p><p><img data-proofer-ignore data-src="/media/Request%20State%20Machine.png" alt="Request State Machine" /></p><p><code class="language-plaintext highlighter-rouge">Request</code> 定义了一个 <code class="language-plaintext highlighter-rouge">MutableState</code> ，用于将可变属性和不可变属性区分开，所有可变属性到放到 <code class="language-plaintext highlighter-rouge">MutableState</code> 中，且使用 <code class="language-plaintext highlighter-rouge">@Protected</code> 声明，保证线程安全。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kd">@Protected</span>
<span class="kd">fileprivate</span> <span class="k">var</span> <span class="nv">mutableState</span> <span class="o">=</span> <span class="kt">MutableState</span><span class="p">()</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Request</code> 的不可变属性：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">/// `UUID` ，作为 `Request` 的唯一 id 使用，用于支持 `Hashble` 和 `Equatable` 协议</span>
<span class="kd">public</span> <span class="k">let</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span>
<span class="c1">/// 串行队列， `Request` 内所有异步调用都是在这个队列内进行</span>
<span class="kd">public</span> <span class="k">let</span> <span class="nv">underlyingQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span>
<span class="c1">/// 进行序列化时所使用到的队列，默认跟 `underlyingQueue` 一致</span>
<span class="kd">public</span> <span class="k">let</span> <span class="nv">serializationQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span>
<span class="c1">/// `EventMonitor` ，下面会说到具体的作用</span>
<span class="kd">public</span> <span class="k">let</span> <span class="nv">eventMonitor</span><span class="p">:</span> <span class="kt">EventMonitor</span><span class="p">?</span>
<span class="c1">/// `Request`'s interceptor ，用于 URL 适配，请求重试，认证等</span>
<span class="kd">public</span> <span class="k">let</span> <span class="nv">interceptor</span><span class="p">:</span> <span class="kt">RequestInterceptor</span><span class="p">?</span>
<span class="c1">/// `Request`'s delegate ，用于调用 `Session` 的一些方法</span>
<span class="kd">public</span> <span class="kd">private(set)</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">RequestDelegate</span><span class="p">?</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Request</code> 的方法和具体内容在后面介绍整体的请求流程时再分析。</p><h3 id="requestdelegate">RequestDelegate</h3><p><code class="language-plaintext highlighter-rouge">RequestDelegate</code> 负责提供一些 <code class="language-plaintext highlighter-rouge">Session</code> 的方法给 <code class="language-plaintext highlighter-rouge">Request</code> 调用， <code class="language-plaintext highlighter-rouge">Request</code> 的 <code class="language-plaintext highlighter-rouge">delegate</code> 都是 <code class="language-plaintext highlighter-rouge">Session</code> 对象。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">RequestDelegate</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="c1">/// 创建 `URLSessionTask` 时使用到的 `URLSessionConfiguration`</span>
    <span class="k">var</span> <span class="nv">sessionConfiguration</span><span class="p">:</span> <span class="kt">URLSessionConfiguration</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>

    <span class="c1">/// 是否直接开始，如果 `startImmediately` 为 `true` ，则当添加第一个 response handler 时就会调用 `resume()` 方法发送请求</span>
    <span class="k">var</span> <span class="nv">startImmediately</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>

    <span class="c1">/// 清除 Session 中关于 Request 的记录</span>
    <span class="kd">func</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">after</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span>

    <span class="c1">/// 异步调用 delegate 的方法，用于判断 Request 是否需要进行重试</span>
    <span class="kd">func</span> <span class="nf">retryResult</span><span class="p">(</span><span class="k">for</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="n">dueTo</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">AFError</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">RetryResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>

    <span class="c1">/// 异步重试 Request</span>
    <span class="kd">func</span> <span class="nf">retryRequest</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="n">withDelay</span> <span class="nv">timeDelay</span><span class="p">:</span> <span class="kt">TimeInterval</span><span class="p">?)</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="requesttaskmap">RequestTaskMap</h3><p><code class="language-plaintext highlighter-rouge">RequestTaskMap</code> 用于串联 <code class="language-plaintext highlighter-rouge">URLSessionTask</code> 和 <code class="language-plaintext highlighter-rouge">Request</code> ，当请求结果更新时，需要根据 <code class="language-plaintext highlighter-rouge">URLSessionTask</code> 找到对应的 <code class="language-plaintext highlighter-rouge">Request</code> ，进行处理。或者通过 <code class="language-plaintext highlighter-rouge">Request</code> 找到对应的 <code class="language-plaintext highlighter-rouge">URLSessionTask</code> 。定义了两个 <code class="language-plaintext highlighter-rouge">Dictionary</code> ，用于实现两者之间的 <code class="language-plaintext highlighter-rouge">map</code> ，通过 <code class="language-plaintext highlighter-rouge">subscript</code> 方法提供下标设置和访问：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">RequestTaskMap</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">tasksToRequests</span><span class="p">:</span> <span class="p">[</span><span class="kt">URLSessionTask</span><span class="p">:</span> <span class="kt">Request</span><span class="p">]</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">requestsToTasks</span><span class="p">:</span> <span class="p">[</span><span class="kt">Request</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">]</span>
    
	  <span class="nf">init</span><span class="p">(</span><span class="nv">tasksToRequests</span><span class="p">:</span> <span class="p">[</span><span class="kt">URLSessionTask</span><span class="p">:</span> <span class="kt">Request</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:],</span>
         <span class="nv">requestsToTasks</span><span class="p">:</span> <span class="p">[</span><span class="kt">Request</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:],</span>
         <span class="nv">taskEvents</span><span class="p">:</span> <span class="p">[</span><span class="kt">URLSessionTask</span><span class="p">:</span> <span class="p">(</span><span class="nv">completed</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="nv">metricsGathered</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[:])</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tasksToRequests</span> <span class="o">=</span> <span class="n">tasksToRequests</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requestsToTasks</span> <span class="o">=</span> <span class="n">requestsToTasks</span>
        <span class="k">self</span><span class="o">.</span><span class="n">taskEvents</span> <span class="o">=</span> <span class="n">taskEvents</span>
    <span class="p">}</span>

	  <span class="nf">subscript</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">URLSessionTask</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="n">requestsToTasks</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">newValue</span> <span class="o">=</span> <span class="n">newValue</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="n">requestsToTasks</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nf">fatalError</span><span class="p">(</span><span class="s">"RequestTaskMap consistency error: no task corresponding to request found."</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="n">requestsToTasks</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
                <span class="n">tasksToRequests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">task</span><span class="p">)</span>
                <span class="n">taskEvents</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">task</span><span class="p">)</span>

                <span class="k">return</span>
            <span class="p">}</span>

            <span class="n">requestsToTasks</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span>
            <span class="n">tasksToRequests</span><span class="p">[</span><span class="n">newValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span>
            <span class="n">taskEvents</span><span class="p">[</span><span class="n">newValue</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">completed</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nv">metricsGathered</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nf">subscript</span><span class="p">(</span><span class="n">_</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Request</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="n">tasksToRequests</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">newValue</span> <span class="o">=</span> <span class="n">newValue</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="n">tasksToRequests</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nf">fatalError</span><span class="p">(</span><span class="s">"RequestTaskMap consistency error: no request corresponding to task found."</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="n">tasksToRequests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">task</span><span class="p">)</span>
                <span class="n">requestsToTasks</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
                <span class="n">taskEvents</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">task</span><span class="p">)</span>

                <span class="k">return</span>
            <span class="p">}</span>

            <span class="n">tasksToRequests</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span>
            <span class="n">requestsToTasks</span><span class="p">[</span><span class="n">newValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
            <span class="n">taskEvents</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">completed</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nv">metricsGathered</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="eventmonitor">EventMonitor</h3><p><code class="language-plaintext highlighter-rouge">EventMonitor</code> 协议可以用来获取 <code class="language-plaintext highlighter-rouge">Request</code> 各种方法和状态的相关回调，一种最常见的用法就是打印日志：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="kt">Logger</span><span class="p">:</span> <span class="kt">EventMonitor</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>
    
    <span class="c1">// Event called when any type of Request is resumed.</span>
    <span class="kd">func</span> <span class="nf">requestDidResume</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Resuming: </span><span class="se">\(</span><span class="n">request</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">// Event called whenever a DataRequest has parsed a response.</span>
    <span class="kd">func</span> <span class="n">request</span><span class="o">&lt;</span><span class="kt">Value</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">DataRequest</span><span class="p">,</span> <span class="n">didParseResponse</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">DataResponse</span><span class="o">&lt;</span><span class="kt">Value</span><span class="p">,</span> <span class="kt">AFError</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Finished: </span><span class="se">\(</span><span class="n">response</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">let</span> <span class="nv">logger</span> <span class="o">=</span> <span class="kt">Logger</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">Session</span><span class="p">(</span><span class="nv">eventMonitors</span><span class="p">:</span> <span class="p">[</span><span class="n">logger</span><span class="p">])</span>
</pre></table></code></div></div><p>可以看到 <code class="language-plaintext highlighter-rouge">Session</code> 支持多个 <code class="language-plaintext highlighter-rouge">eventMonitors</code> 。 Alamofire 里面为了让调用方可以更灵活地使用 <code class="language-plaintext highlighter-rouge">EventMonitor</code> ，添加了一个 <code class="language-plaintext highlighter-rouge">extension</code> ，里面实现了 <code class="language-plaintext highlighter-rouge">EventMonitor</code> 的全部方法和属性，这样调用方就不需要实现 <code class="language-plaintext highlighter-rouge">EventMonitor</code> 的全部方法，可以根据自己需要添加对应的方法即可，算是一种 <code class="language-plaintext highlighter-rouge">protocol</code> 实现 <code class="language-plaintext highlighter-rouge">optional</code> 方法的曲线救国方式。</p><p>为了支持多个 <code class="language-plaintext highlighter-rouge">eventMonitors</code> 和抽离 <code class="language-plaintext highlighter-rouge">EventMonitor</code> 的处理， Alamofire 实现了一个 <code class="language-plaintext highlighter-rouge">CompositeEventMonitor</code> 类，用于组合各个 <code class="language-plaintext highlighter-rouge">EventMonitors</code> ，在它自己的回调方法里遍历各个 <code class="language-plaintext highlighter-rouge">EventMonitors</code> ，调用对应的方法：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">/// An `EventMonitor` which can contain multiple `EventMonitor`s and calls their methods on their queues.</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">CompositeEventMonitor</span><span class="p">:</span> <span class="kt">EventMonitor</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"org.alamofire.compositeEventMonitor"</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">utility</span><span class="p">)</span>

    <span class="k">let</span> <span class="nv">monitors</span><span class="p">:</span> <span class="p">[</span><span class="kt">EventMonitor</span><span class="p">]</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">monitors</span><span class="p">:</span> <span class="p">[</span><span class="kt">EventMonitor</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="n">monitors</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">EventMonitor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">monitor</span> <span class="k">in</span> <span class="k">self</span><span class="o">.</span><span class="n">monitors</span> <span class="p">{</span>
                <span class="n">monitor</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">event</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="n">didBecomeInvalidWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">performEvent</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">urlSession</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="nv">didBecomeInvalidWithError</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Session</code> 中则定义了一个 <code class="language-plaintext highlighter-rouge">eventMonitor: CompositeEventMonitor</code> 属性，用于组合多个 <code class="language-plaintext highlighter-rouge">EventMonitor</code> 。 Alamofire 提供了一个 打印日志的例子： <a href="https://github.com/Alamofire/Alamofire/blob/master/Tests/NSLoggingEventMonitor.swift"><code class="language-plaintext highlighter-rouge">NSLoggingEventMonitor.swift</code></a></p><h3 id="response">Response</h3><p>对请求结果进行封装，根据类型不同分为 <code class="language-plaintext highlighter-rouge">DataResponse</code> 和 <code class="language-plaintext highlighter-rouge">DownloadResponse</code> 。 <code class="language-plaintext highlighter-rouge">DataRequest</code> 或者 <code class="language-plaintext highlighter-rouge">UploadRequest</code> 请求返回的结果是 <code class="language-plaintext highlighter-rouge">DataResponse&lt;Success, Failure: Error&gt;</code> 。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">DataResponse</span><span class="o">&lt;</span><span class="kt">Success</span><span class="p">,</span> <span class="kt">Failure</span><span class="p">:</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">/// 对应的 URLRequest</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">?</span>

    <span class="c1">/// 服务器返回的 HTTPURLResponse</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">?</span>

    <span class="c1">/// 服务器返回的 Data</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?</span>

    <span class="c1">/// 响应对应的 URLSessionTaskMetrics</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">metrics</span><span class="p">:</span> <span class="kt">URLSessionTaskMetrics</span><span class="p">?</span>

    <span class="c1">/// 序列化所消耗的时间</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">serializationDuration</span><span class="p">:</span> <span class="kt">TimeInterval</span>

    <span class="c1">/// 序列化的结果</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Success</span><span class="p">,</span> <span class="kt">Failure</span><span class="o">&gt;</span>

    <span class="kd">public</span> <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Success</span><span class="p">?</span> <span class="p">{</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="p">}</span>

    <span class="kd">public</span> <span class="k">var</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Failure</span><span class="p">?</span> <span class="p">{</span> <span class="n">result</span><span class="o">.</span><span class="n">failure</span> <span class="p">}</span>

    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">?,</span>
                <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">?,</span>
                <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?,</span>
                <span class="nv">metrics</span><span class="p">:</span> <span class="kt">URLSessionTaskMetrics</span><span class="p">?,</span>
                <span class="nv">serializationDuration</span><span class="p">:</span> <span class="kt">TimeInterval</span><span class="p">,</span>
                <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Success</span><span class="p">,</span> <span class="kt">Failure</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="k">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="k">self</span><span class="o">.</span><span class="n">serializationDuration</span> <span class="o">=</span> <span class="n">serializationDuration</span>
        <span class="k">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>跟 <code class="language-plaintext highlighter-rouge">Result</code> 类似， Alamofire 也为 <code class="language-plaintext highlighter-rouge">DataResponse</code> 添加了 <code class="language-plaintext highlighter-rouge">map&lt;NewSuccess&gt;</code> ， <code class="language-plaintext highlighter-rouge">tryMap&lt;NewSuccess&gt;</code> ， <code class="language-plaintext highlighter-rouge">mapError&lt;NewFailure: Error&gt;</code> 和 <code class="language-plaintext highlighter-rouge">tryMapError&lt;NewFailure: Error&gt;</code> 这几个方法。</p><p><code class="language-plaintext highlighter-rouge">DownloadRequest</code> 对应的则是 <code class="language-plaintext highlighter-rouge">DownloadResponse&lt;Success, Failure: Error&gt;</code> ，大部分属性跟 <code class="language-plaintext highlighter-rouge">DataResponse</code> 一致，新增以下两个属性：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">/// 用于存储响应的数据的文件 URL</span>
<span class="kd">public</span> <span class="k">let</span> <span class="nv">fileURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">?</span>

<span class="c1">/// 取消请求时所接收到的数据</span>
<span class="kd">public</span> <span class="k">let</span> <span class="nv">resumeData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?</span>
</pre></table></code></div></div><h3 id="sessiondelegate">SessionDelegate</h3><p><code class="language-plaintext highlighter-rouge">SessionDelegate</code> 负责处理 <code class="language-plaintext highlighter-rouge">URLSessionDelegate</code> 的相关方法，相当于 <code class="language-plaintext highlighter-rouge">Session</code> 和 <code class="language-plaintext highlighter-rouge">URLSessionDelegate</code> 的一个中间层。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">/// 负责调用 Session 的一些方法和获取对应的属性</span>
<span class="kd">protocol</span> <span class="kt">SessionStateProvider</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">serverTrustManager</span><span class="p">:</span> <span class="kt">ServerTrustManager</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">redirectHandler</span><span class="p">:</span> <span class="kt">RedirectHandler</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">cachedResponseHandler</span><span class="p">:</span> <span class="kt">CachedResponseHandler</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="k">for</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Request</span><span class="p">?</span>
    <span class="kd">func</span> <span class="nf">didGatherMetricsForTask</span><span class="p">(</span><span class="n">_</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">didCompleteTask</span><span class="p">(</span><span class="n">_</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">credential</span><span class="p">(</span><span class="k">for</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="k">in</span> <span class="nv">protectionSpace</span><span class="p">:</span> <span class="kt">URLProtectionSpace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">URLCredential</span><span class="p">?</span>
    <span class="kd">func</span> <span class="nf">cancelRequestsForSessionInvalidation</span><span class="p">(</span><span class="n">with</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>下面是默认的 <code class="language-plaintext highlighter-rouge">SessionDelegate</code> 实现，你可以在初始化 <code class="language-plaintext highlighter-rouge">Session</code> 时提供自定义的 <code class="language-plaintext highlighter-rouge">SessionDelegate</code> 的子类：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">/// Class which implements the various `URLSessionDelegate` methods to connect various Alamofire features.</span>
<span class="kd">open</span> <span class="kd">class</span> <span class="kt">SessionDelegate</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">fileManager</span><span class="p">:</span> <span class="kt">FileManager</span>

    <span class="c1">// stateProvider 就是 Session </span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">stateProvider</span><span class="p">:</span> <span class="kt">SessionStateProvider</span><span class="p">?</span>
    <span class="c1">// eventMonitor</span>
    <span class="k">var</span> <span class="nv">eventMonitor</span><span class="p">:</span> <span class="kt">EventMonitor</span><span class="p">?</span>

    <span class="c1">// 提供一个 fileManager 属性，用于管理下载文件</span>
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">fileManager</span><span class="p">:</span> <span class="kt">FileManager</span> <span class="o">=</span> <span class="o">.</span><span class="k">default</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">fileManager</span> <span class="o">=</span> <span class="n">fileManager</span>
    <span class="p">}</span>

    <span class="c1">// 通过 stateProvider 即 Session 获取对应的 Request</span>
    <span class="kd">func</span> <span class="n">request</span><span class="o">&lt;</span><span class="kt">R</span><span class="p">:</span> <span class="kt">Request</span><span class="o">&gt;</span><span class="p">(</span><span class="k">for</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="k">as</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">R</span><span class="o">.</span><span class="k">Type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">R</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">provider</span> <span class="o">=</span> <span class="n">stateProvider</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">assertionFailure</span><span class="p">(</span><span class="s">"StateProvider is nil."</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">provider</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">task</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">R</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>当 <code class="language-plaintext highlighter-rouge">URLSession</code> 无效后调用 <code class="language-plaintext highlighter-rouge">eventMonitor</code> 对应的方法，以及调用 <code class="language-plaintext highlighter-rouge">stateProvider</code> 取消所有 <code class="language-plaintext highlighter-rouge">requests</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">SessionDelegate</span><span class="p">:</span> <span class="kt">URLSessionDelegate</span> <span class="p">{</span>
    <span class="kd">open</span> <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="n">didBecomeInvalidWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">eventMonitor</span><span class="p">?</span><span class="o">.</span><span class="nf">urlSession</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="nv">didBecomeInvalidWithError</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>

        <span class="n">stateProvider</span><span class="p">?</span><span class="o">.</span><span class="nf">cancelRequestsForSessionInvalidation</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">SessionDelegate</code> 也定义了 <code class="language-plaintext highlighter-rouge">URLSessionTaskDelegate</code> ， <code class="language-plaintext highlighter-rouge">URLSessionDataDelegate</code> 和 <code class="language-plaintext highlighter-rouge">URLSessionDownloadDelegate</code> 的方法，基本实现和上面的大同小异，负责调用 <code class="language-plaintext highlighter-rouge">EventMonitor</code> ， <code class="language-plaintext highlighter-rouge">Session</code> 和 <code class="language-plaintext highlighter-rouge">Request</code> 的相关方法。</p><h3 id="urlconvertibleurlrequestconvertible">URLConvertible+URLRequestConvertible</h3><p><code class="language-plaintext highlighter-rouge">URLconvertible</code> 协议，用于转化为 <code class="language-plaintext highlighter-rouge">URL</code> 。当我们发起一个网络请求时就需要构建一个对应的 <code class="language-plaintext highlighter-rouge">URL</code> ，为了方便调用方可以直接传递 <code class="language-plaintext highlighter-rouge">String</code> ， <code class="language-plaintext highlighter-rouge">URL</code> 或者 <code class="language-plaintext highlighter-rouge">URLComponents</code> 来生成 <code class="language-plaintext highlighter-rouge">URL</code> ，而不需要自己先生成 <code class="language-plaintext highlighter-rouge">URL</code> 。同时也可以自定义一些生成 <code class="language-plaintext highlighter-rouge">URL</code> 的规则，只要支持 <code class="language-plaintext highlighter-rouge">URLConvertible</code> 协议即可。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">URLConvertible</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">asURL</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URL</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">String</code> ， <code class="language-plaintext highlighter-rouge">URL</code> 和 <code class="language-plaintext highlighter-rouge">URLComponents</code> 默认支持 <code class="language-plaintext highlighter-rouge">URLConvertible</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">String</span><span class="p">:</span> <span class="kt">URLConvertible</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">asURL</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URL</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="kt">AFError</span><span class="o">.</span><span class="nf">invalidURL</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">url</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">URL</span><span class="p">:</span> <span class="kt">URLConvertible</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">asURL</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URL</span> <span class="p">{</span> <span class="k">self</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">URLComponents</span><span class="p">:</span> <span class="kt">URLConvertible</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">asURL</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URL</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">url</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="kt">AFError</span><span class="o">.</span><span class="nf">invalidURL</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">url</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>所以 Alamofire 默认支持以下三种发起请求的方式：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">urlString</span> <span class="o">=</span> <span class="s">"https://httpbin.org/get"</span>
<span class="kt">AF</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">urlString</span><span class="p">)</span><span class="o">!</span>
<span class="kt">AF</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">urlComponents</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span><span class="o">!</span>
<span class="kt">AF</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlComponents</span><span class="p">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 则是用于生成 <code class="language-plaintext highlighter-rouge">URLRequest</code> 的协议，通过 <code class="language-plaintext highlighter-rouge">URLRequest</code> 可以生成对应的 <code class="language-plaintext highlighter-rouge">URLSessionTask</code> 。 <code class="language-plaintext highlighter-rouge">URLRequest</code> 默认支持 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">URLRequestConvertible</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">asURLRequest</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">URLRequestConvertible</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">urlRequest</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">?</span> <span class="p">{</span> <span class="k">try</span><span class="p">?</span> <span class="nf">asURLRequest</span><span class="p">()</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">URLRequest</span><span class="p">:</span> <span class="kt">URLRequestConvertible</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">asURLRequest</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span> <span class="p">{</span> <span class="k">self</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 给 URLRequest 添加了一个初始化方法，方便在初始化时直接设置 method 和 allHTTPHeaderFields</span>
<span class="kd">extension</span> <span class="kt">URLRequest</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URLConvertible</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span><span class="p">,</span> <span class="nv">headers</span><span class="p">:</span> <span class="kt">HTTPHeaders</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="k">try</span> <span class="n">url</span><span class="o">.</span><span class="nf">asURL</span><span class="p">()</span>

        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>

        <span class="n">httpMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">rawValue</span>
        <span class="n">allHTTPHeaderFields</span> <span class="o">=</span> <span class="n">headers</span><span class="p">?</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>通过 <code class="language-plaintext highlighter-rouge">URLRequest</code> 发送请求：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://httpbin.org/post"</span><span class="p">)</span><span class="o">!</span>
<span class="k">var</span> <span class="nv">urlRequest</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="n">urlRequest</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="o">.</span><span class="n">post</span>

<span class="k">let</span> <span class="nv">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">:</span> <span class="s">"bar"</span><span class="p">]</span>

<span class="k">do</span> <span class="p">{</span>
    <span class="n">urlRequest</span><span class="o">.</span><span class="n">httpBody</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">JSONEncoder</span><span class="p">()</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
    <span class="c1">// Handle error.</span>
<span class="p">}</span>

<span class="n">urlRequest</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="o">.</span><span class="nf">contentType</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">))</span>
<span class="kt">AF</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlRequest</span><span class="p">)</span>
</pre></table></code></div></div><p>这样可以把具体对象抽离出来，提供的参数只需要支持 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 协议即可。当我们的 App 有大量的请求接口需要进行定义时，可以通过 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 协议来定义相关的参数编码，请求方法等。如下面代码所示，可以定一个 <code class="language-plaintext highlighter-rouge">enum Router</code> ， 支持 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 类型，这样在调用时生成对应的 <code class="language-plaintext highlighter-rouge">enum</code> 就可以了。这为调用方提供了横向扩展的能力， Alamofire 不需要知道具体的对象类型，只需要通过 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 来进行 <code class="language-plaintext highlighter-rouge">URLRequest</code> 转换，这样有利于我们对网络层的请求进行组织和整理。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">Router</span><span class="p">:</span> <span class="kt">URLRequestConvertible</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nf">get</span><span class="p">([</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]),</span> <span class="nf">post</span><span class="p">([</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span>
    
    <span class="k">var</span> <span class="nv">baseURL</span><span class="p">:</span> <span class="kt">URL</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://httpbin.org"</span><span class="p">)</span><span class="o">!</span>
    <span class="p">}</span>
    
    <span class="k">var</span> <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">get</span><span class="p">:</span> <span class="k">return</span> <span class="o">.</span><span class="k">get</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">post</span><span class="p">:</span> <span class="k">return</span> <span class="o">.</span><span class="n">post</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">var</span> <span class="nv">path</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">get</span><span class="p">:</span> <span class="k">return</span> <span class="s">"get"</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">post</span><span class="p">:</span> <span class="k">return</span> <span class="s">"post"</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">asURLRequest</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">baseURL</span><span class="o">.</span><span class="nf">appendingPathComponent</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">URLEncodedFormParameterEncoder</span><span class="p">()</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nv">into</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">post</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">JSONParameterEncoder</span><span class="p">()</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nv">into</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">request</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="resultalamofire">Result+Alamofire</h3><p>Alamofire 为了使用 <code class="language-plaintext highlighter-rouge">Result</code> 更方便而定义的一些便捷方法。 使用 <code class="language-plaintext highlighter-rouge">typealias</code> 定义了一个 <code class="language-plaintext highlighter-rouge">AFResult</code> ，其 <code class="language-plaintext highlighter-rouge">Failure</code> 类型固定为 <code class="language-plaintext highlighter-rouge">AFError</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">typealias</span> <span class="kt">AFResult</span><span class="o">&lt;</span><span class="kt">Success</span><span class="o">&gt;</span> <span class="o">=</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Success</span><span class="p">,</span> <span class="kt">AFError</span><span class="o">&gt;</span>
</pre></table></code></div></div><p>判断是否为 <code class="language-plaintext highlighter-rouge">.success</code> 和 <code class="language-plaintext highlighter-rouge">.failure</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">isSuccess</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">case</span> <span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span> <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="k">var</span> <span class="nv">isFailure</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="o">!</span><span class="n">isSuccess</span>
<span class="p">}</span>
</pre></table></code></div></div><p>获取对应的值：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">success</span><span class="p">:</span> <span class="kt">Success</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">value</span>
<span class="p">}</span>

<span class="k">var</span> <span class="nv">failure</span><span class="p">:</span> <span class="kt">Failure</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">error</span>
<span class="p">}</span>
</pre></table></code></div></div><p>通过 <code class="language-plaintext highlighter-rouge">Success</code> 和 <code class="language-plaintext highlighter-rouge">Failure</code> 进行初始化：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nf">init</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="kt">Success</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Failure</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="k">self</span> <span class="o">=</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">self</span> <span class="o">=</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">tryMap</code> 对 <code class="language-plaintext highlighter-rouge">Success</code> 进行转换，在转换过程中可以抛出 <code class="language-plaintext highlighter-rouge">Error</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="n">tryMap</span><span class="o">&lt;</span><span class="kt">NewSuccess</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">transform</span><span class="p">:</span> <span class="p">(</span><span class="kt">Success</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">NewSuccess</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">NewSuccess</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="nf">transform</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>用法如下：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">possibleData</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="kt">Data</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">possibleObject</span> <span class="o">=</span> <span class="n">possibleData</span><span class="o">.</span><span class="n">tryMap</span> <span class="p">{</span>
    <span class="k">try</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">jsonObject</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">tryMapError</code> 对 <code class="language-plaintext highlighter-rouge">Failure</code> 进行转换，在转换过程中也可以抛出 <code class="language-plaintext highlighter-rouge">Error</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="n">tryMapError</span><span class="o">&lt;</span><span class="kt">NewFailure</span><span class="p">:</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">transform</span><span class="p">:</span> <span class="p">(</span><span class="kt">Failure</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">NewFailure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Success</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="nf">transform</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>用法如下：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">possibleData</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="kt">Data</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">possibleObject</span> <span class="o">=</span> <span class="n">possibleData</span><span class="o">.</span><span class="n">tryMapError</span> <span class="p">{</span>
    <span class="k">try</span> <span class="nf">someFailableFunction</span><span class="p">(</span><span class="nv">taking</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="整体流程">整体流程</h2><p><code class="language-plaintext highlighter-rouge">Session</code> 作为 Alamofire 的第一层入口，所有 <code class="language-plaintext highlighter-rouge">Alamofire.swift</code> 的请求方法都会调用 <code class="language-plaintext highlighter-rouge">Session</code> 里面对应的方法。<code class="language-plaintext highlighter-rouge">Session</code> 负责创建和管理 Alamofire 的 <code class="language-plaintext highlighter-rouge">Request</code> 类。同时也提供一些公共的方法给所有 <code class="language-plaintext highlighter-rouge">Request</code> 使用，如请求队列，信任管理，重定向处理和响应缓存处理等。<code class="language-plaintext highlighter-rouge">Session</code> 类似于一个 Manager 的角色，处理各个请求的创建流程。</p><p>当创建一个 <code class="language-plaintext highlighter-rouge">Request</code> 的子类后， Alamofire 会进行一系列的操作来完成这个请求。一个成功的请求包括以下流程：</p><ol><li>一些初始化参数，比如 HTTP 方法， HTTP 头和参数等会被封装进内部的 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 值中，用于初始化 <code class="language-plaintext highlighter-rouge">Request</code> ；<li>调用 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 的 <code class="language-plaintext highlighter-rouge">asURLRequest()</code> 方法来创建第一个 <code class="language-plaintext highlighter-rouge">URLRequest</code> 。 <code class="language-plaintext highlighter-rouge">URLRequest</code> 会存储到 <code class="language-plaintext highlighter-rouge">Request</code> 的 <code class="language-plaintext highlighter-rouge">mutableState.requests</code> 属性中。如果有定义 <code class="language-plaintext highlighter-rouge">RequestModifier</code> ， 在生成 <code class="language-plaintext highlighter-rouge">URLRequest</code> 会进行调用来调整 <code class="language-plaintext highlighter-rouge">URLRequest</code> ；<li>如果 <code class="language-plaintext highlighter-rouge">Session</code> 或者 <code class="language-plaintext highlighter-rouge">Request</code> 有提供 <code class="language-plaintext highlighter-rouge">RequestAdapters</code> 或者 <code class="language-plaintext highlighter-rouge">RequestInterceptors</code> ，则会对之前生成的 <code class="language-plaintext highlighter-rouge">URLRequest</code> 进行调整，同时也会存储到 <code class="language-plaintext highlighter-rouge">Request</code> 的 <code class="language-plaintext highlighter-rouge">mutableState.requests</code> 属性中；<li><code class="language-plaintext highlighter-rouge">Session</code> 调用 <code class="language-plaintext highlighter-rouge">Request</code> 的方法来生成对应的 <code class="language-plaintext highlighter-rouge">URLSessionTask</code> ，不同的 <code class="language-plaintext highlighter-rouge">Request</code> 子类 会生成不同的 <code class="language-plaintext highlighter-rouge">URLSessionTask</code> ；<li>当 <code class="language-plaintext highlighter-rouge">URLSessionTask</code> 完成任务，且已经收集到 <code class="language-plaintext highlighter-rouge">URLSessionTaskMetrics</code> ， <code class="language-plaintext highlighter-rouge">Request</code> 就会执行自己的 <code class="language-plaintext highlighter-rouge">Validators </code> 来验证请求结果是否正确；<li>通过验证后， <code class="language-plaintext highlighter-rouge">Request</code> 就会执行 <code class="language-plaintext highlighter-rouge">mutableState.responseSerializers</code> 来处理请求结果。在上面这些步骤中，每个步骤都有可能产生错误或者接收到网络返回的错误结果，这些错误会传递给对应的 <code class="language-plaintext highlighter-rouge">Request</code> 。在处理结果时会判断是否需要重试。 当 <code class="language-plaintext highlighter-rouge">Error</code> 传递给 <code class="language-plaintext highlighter-rouge">Request</code> 后，<code class="language-plaintext highlighter-rouge">Request</code> 会调用对应的 <code class="language-plaintext highlighter-rouge">RequestRetriers</code> 来判断是否需要进行重试，如果需要进行重试，则再走一次上面的流程。</ol><p>下面以 <code class="language-plaintext highlighter-rouge">DataRequest</code> 为例讲一下发起网络请求的整体流程。</p><h3 id="生成-datarequest">生成 DataRequest</h3><p>Alamofire 为发起 <code class="language-plaintext highlighter-rouge">DataRequest</code> 提供了三个接口：</p><ol><li><code class="language-plaintext highlighter-rouge">parameters</code> 为 <code class="language-plaintext highlighter-rouge">Parameters</code> ，即 <code class="language-plaintext highlighter-rouge">[String: Any]</code> ：</ol><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">open</span> <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">convertible</span><span class="p">:</span> <span class="kt">URLConvertible</span><span class="p">,</span>
                  <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span> <span class="o">=</span> <span class="o">.</span><span class="k">get</span><span class="p">,</span>
                  <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
                  <span class="nv">encoding</span><span class="p">:</span> <span class="kt">ParameterEncoding</span> <span class="o">=</span> <span class="kt">URLEncoding</span><span class="o">.</span><span class="k">default</span><span class="p">,</span>
                  <span class="nv">headers</span><span class="p">:</span> <span class="kt">HTTPHeaders</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
                  <span class="nv">interceptor</span><span class="p">:</span> <span class="kt">RequestInterceptor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
                  <span class="nv">requestModifier</span><span class="p">:</span> <span class="kt">RequestModifier</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">DataRequest</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">convertible</span> <span class="o">=</span> <span class="kt">RequestConvertible</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">convertible</span><span class="p">,</span>
                                         <span class="nv">method</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                                         <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
                                         <span class="nv">encoding</span><span class="p">:</span> <span class="n">encoding</span><span class="p">,</span>
                                         <span class="nv">headers</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span>
                                         <span class="nv">requestModifier</span><span class="p">:</span> <span class="n">requestModifier</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nf">request</span><span class="p">(</span><span class="n">convertible</span><span class="p">,</span> <span class="nv">interceptor</span><span class="p">:</span> <span class="n">interceptor</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>定义一个 <code class="language-plaintext highlighter-rouge">struct RequestConvertible</code> ，支持 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 协议，负责处理参数的编码和生成对应的 <code class="language-plaintext highlighter-rouge">URLRequest</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">typealias</span> <span class="kt">RequestModifier</span> <span class="o">=</span> <span class="p">(</span><span class="k">inout</span> <span class="kt">URLRequest</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Void</span>

<span class="kd">struct</span> <span class="kt">RequestConvertible</span><span class="p">:</span> <span class="kt">URLRequestConvertible</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URLConvertible</span>
    <span class="k">let</span> <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span>
    <span class="k">let</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span><span class="p">?</span>
    <span class="k">let</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">ParameterEncoding</span>
    <span class="k">let</span> <span class="nv">headers</span><span class="p">:</span> <span class="kt">HTTPHeaders</span><span class="p">?</span>
    <span class="k">let</span> <span class="nv">requestModifier</span><span class="p">:</span> <span class="kt">RequestModifier</span><span class="p">?</span>

    <span class="kd">func</span> <span class="nf">asURLRequest</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span> <span class="nv">headers</span><span class="p">:</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">try</span> <span class="nf">requestModifier</span><span class="p">?(</span><span class="o">&amp;</span><span class="n">request</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">try</span> <span class="n">encoding</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li><code class="language-plaintext highlighter-rouge">parameters</code> 支持 <code class="language-plaintext highlighter-rouge">Encodable</code> ：</ol><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">open</span> <span class="kd">func</span> <span class="n">request</span><span class="o">&lt;</span><span class="kt">Parameters</span><span class="p">:</span> <span class="kt">Encodable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">convertible</span><span class="p">:</span> <span class="kt">URLConvertible</span><span class="p">,</span>
                                         <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span> <span class="o">=</span> <span class="o">.</span><span class="k">get</span><span class="p">,</span>
                                         <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
                                         <span class="nv">encoder</span><span class="p">:</span> <span class="kt">ParameterEncoder</span> <span class="o">=</span> <span class="kt">URLEncodedFormParameterEncoder</span><span class="o">.</span><span class="k">default</span><span class="p">,</span>
                                         <span class="nv">headers</span><span class="p">:</span> <span class="kt">HTTPHeaders</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
                                         <span class="nv">interceptor</span><span class="p">:</span> <span class="kt">RequestInterceptor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
                                         <span class="nv">requestModifier</span><span class="p">:</span> <span class="kt">RequestModifier</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">DataRequest</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">convertible</span> <span class="o">=</span> <span class="kt">RequestEncodableConvertible</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">convertible</span><span class="p">,</span>
                                                  <span class="nv">method</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                                                  <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
                                                  <span class="nv">encoder</span><span class="p">:</span> <span class="n">encoder</span><span class="p">,</span>
                                                  <span class="nv">headers</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span>
                                                  <span class="nv">requestModifier</span><span class="p">:</span> <span class="n">requestModifier</span><span class="p">)</span>

    <span class="k">return</span> <span class="nf">request</span><span class="p">(</span><span class="n">convertible</span><span class="p">,</span> <span class="nv">interceptor</span><span class="p">:</span> <span class="n">interceptor</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>由于参数编码方式不同，所以需要定义一个 <code class="language-plaintext highlighter-rouge">struct RequestEncodableConvertible&lt;Parameters: Encodable&gt;</code> ，来处理参数为 <code class="language-plaintext highlighter-rouge">Encodable</code> 时的编码和生成 <code class="language-plaintext highlighter-rouge">URLRequest</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">RequestEncodableConvertible</span><span class="o">&lt;</span><span class="kt">Parameters</span><span class="p">:</span> <span class="kt">Encodable</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">URLRequestConvertible</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URLConvertible</span>
    <span class="k">let</span> <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span>
    <span class="k">let</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span><span class="p">?</span>
    <span class="k">let</span> <span class="nv">encoder</span><span class="p">:</span> <span class="kt">ParameterEncoder</span>
    <span class="k">let</span> <span class="nv">headers</span><span class="p">:</span> <span class="kt">HTTPHeaders</span><span class="p">?</span>
    <span class="k">let</span> <span class="nv">requestModifier</span><span class="p">:</span> <span class="kt">RequestModifier</span><span class="p">?</span>

    <span class="kd">func</span> <span class="nf">asURLRequest</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span> <span class="nv">headers</span><span class="p">:</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">try</span> <span class="nf">requestModifier</span><span class="p">?(</span><span class="o">&amp;</span><span class="n">request</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">try</span> <span class="n">parameters</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="k">try</span> <span class="n">encoder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="nv">$0</span><span class="p">,</span> <span class="nv">into</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span> <span class="p">}</span> <span class="p">??</span> <span class="n">request</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>上面两个接口经过处理生成对应的 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 后会调用这个接口来生成 <code class="language-plaintext highlighter-rouge">DataRequest</code> ，在使用的时候也可以自己生成 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> ，直接调用这个接口：</ol><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">open</span> <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">convertible</span><span class="p">:</span> <span class="kt">URLRequestConvertible</span><span class="p">,</span> <span class="nv">interceptor</span><span class="p">:</span> <span class="kt">RequestInterceptor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">DataRequest</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">DataRequest</span><span class="p">(</span><span class="nv">convertible</span><span class="p">:</span> <span class="n">convertible</span><span class="p">,</span>
                              <span class="nv">underlyingQueue</span><span class="p">:</span> <span class="n">rootQueue</span><span class="p">,</span>
                              <span class="nv">serializationQueue</span><span class="p">:</span> <span class="n">serializationQueue</span><span class="p">,</span>
                              <span class="nv">eventMonitor</span><span class="p">:</span> <span class="n">eventMonitor</span><span class="p">,</span>
                              <span class="nv">interceptor</span><span class="p">:</span> <span class="n">interceptor</span><span class="p">,</span>
                              <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>

    <span class="nf">perform</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">request</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这样可以统一 <code class="language-plaintext highlighter-rouge">DataRequest</code> 的处理流程，虽然可以通过不同的参数来生成 <code class="language-plaintext highlighter-rouge">DataRequest</code> ，但是在 <code class="language-plaintext highlighter-rouge">Session</code> 内部的处理时，会通过 <code class="language-plaintext highlighter-rouge">URLRequestConvertible</code> 进行转换，收敛到同一个接口中。</p><h3 id="perform">perform</h3><p>这里 <code class="language-plaintext highlighter-rouge">perform</code> 跟 <code class="language-plaintext highlighter-rouge">resume</code> 不同，不会发起真正的网络请求，只是用来进行进行请求前的准备工作：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">perform</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rootQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
        <span class="c1">// 1.</span>
        <span class="k">guard</span> <span class="o">!</span><span class="n">request</span><span class="o">.</span><span class="n">isCancelled</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="c1">// 2.</span>
        <span class="k">self</span><span class="o">.</span><span class="n">activeRequests</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requestQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
            <span class="c1">// 3.</span>
            <span class="k">switch</span> <span class="n">request</span> <span class="p">{</span>
            <span class="k">case</span> <span class="k">let</span> <span class="nv">r</span> <span class="k">as</span> <span class="kt">UploadRequest</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="nf">performUploadRequest</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1">// UploadRequest must come before DataRequest due to subtype relationship.</span>
            <span class="k">case</span> <span class="k">let</span> <span class="nv">r</span> <span class="k">as</span> <span class="kt">DataRequest</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="nf">performDataRequest</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">case</span> <span class="k">let</span> <span class="nv">r</span> <span class="k">as</span> <span class="kt">DownloadRequest</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="nf">performDownloadRequest</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">case</span> <span class="k">let</span> <span class="nv">r</span> <span class="k">as</span> <span class="kt">DataStreamRequest</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="nf">performDataStreamRequest</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">default</span><span class="p">:</span> <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Attempted to perform unsupported Request subclass: </span><span class="se">\(</span><span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>判断 <code class="language-plaintext highlighter-rouge">request</code> 是否有取消，因为有可能还没发起请求就已经被取消了；<li>添加到 <code class="language-plaintext highlighter-rouge">activeRequests</code> 中；<li>使用 switch case let 进行类型判断</ol><p>然后调用 <code class="language-plaintext highlighter-rouge">performSetupOperations</code> 方法进行一些请求前的准备工作。 在处理过程中会判断是否有设置 <code class="language-plaintext highlighter-rouge">adapter</code> ，如果有设置 <code class="language-plaintext highlighter-rouge">adapter</code> ，则调用 <code class="language-plaintext highlighter-rouge">adapter</code> 对请求做一次适配。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">performSetupOperations</span><span class="p">(</span><span class="k">for</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="nv">convertible</span><span class="p">:</span> <span class="kt">URLRequestConvertible</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">dispatchPrecondition</span><span class="p">(</span><span class="nv">condition</span><span class="p">:</span> <span class="o">.</span><span class="nf">onQueue</span><span class="p">(</span><span class="n">requestQueue</span><span class="p">))</span>

    <span class="k">let</span> <span class="nv">initialRequest</span><span class="p">:</span> <span class="kt">URLRequest</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="c1">// 1.</span>
        <span class="n">initialRequest</span> <span class="o">=</span> <span class="k">try</span> <span class="n">convertible</span><span class="o">.</span><span class="nf">asURLRequest</span><span class="p">()</span>
        <span class="c1">// 2.</span>
        <span class="k">try</span> <span class="n">initialRequest</span><span class="o">.</span><span class="nf">validate</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="n">rootQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="nf">didFailToCreateURLRequest</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="o">.</span><span class="nf">asAFError</span><span class="p">(</span><span class="nv">or</span><span class="p">:</span> <span class="o">.</span><span class="nf">createURLRequestFailed</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">)))</span> <span class="p">}</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="c1">// 3.</span>
    <span class="n">rootQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="nf">didCreateInitialURLRequest</span><span class="p">(</span><span class="n">initialRequest</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">guard</span> <span class="o">!</span><span class="n">request</span><span class="o">.</span><span class="n">isCancelled</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="c1">// 4. </span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">adapter</span> <span class="o">=</span> <span class="nf">adapter</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">rootQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="nf">didCreateURLRequest</span><span class="p">(</span><span class="n">initialRequest</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="c1">// 5.</span>
    <span class="n">adapter</span><span class="o">.</span><span class="nf">adapt</span><span class="p">(</span><span class="n">initialRequest</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">adaptedRequest</span> <span class="o">=</span> <span class="k">try</span> <span class="n">result</span><span class="o">.</span><span class="nf">get</span><span class="p">()</span>
            <span class="k">try</span> <span class="n">adaptedRequest</span><span class="o">.</span><span class="nf">validate</span><span class="p">()</span>

            <span class="k">self</span><span class="o">.</span><span class="n">rootQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
                <span class="n">request</span><span class="o">.</span><span class="nf">didAdaptInitialRequest</span><span class="p">(</span><span class="n">initialRequest</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">adaptedRequest</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="nf">didCreateURLRequest</span><span class="p">(</span><span class="n">adaptedRequest</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">rootQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="nf">didFailToAdaptURLRequest</span><span class="p">(</span><span class="n">initialRequest</span><span class="p">,</span> <span class="nv">withError</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestAdaptationFailed</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">))</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>尝试生成对应的 <code class="language-plaintext highlighter-rouge">URLRequest</code> ；<li>检验 <code class="language-plaintext highlighter-rouge">URLRequest</code> 是否符合格式要求，如果是 <code class="language-plaintext highlighter-rouge">GET</code> 请求，而且 <code class="language-plaintext highlighter-rouge">httpBody</code> 中有数据，就会报一个 <code class="language-plaintext highlighter-rouge">bodyDataInGETRequest</code> 的错；<li>调用 <code class="language-plaintext highlighter-rouge">request</code> 的 <code class="language-plaintext highlighter-rouge">didCreateInitialURLRequest</code> 方法，负责更新 request 的 mutableState 和调用 eventMonitor 对应的方法；<li>判断是否有 <code class="language-plaintext highlighter-rouge">adapter</code> ，如果没有则调用 <code class="language-plaintext highlighter-rouge">didCreateURLRequest</code> 进行一些最后的处理工作；<li>使用 <code class="language-plaintext highlighter-rouge">adapter</code> 对 <code class="language-plaintext highlighter-rouge">request</code> 进行转换，然后调用 <code class="language-plaintext highlighter-rouge">request.didAdaptInitialRequest</code> 和 <code class="language-plaintext highlighter-rouge">didCreateURLRequest</code> ；</ol><p>可以看到上面的代码在调用 <code class="language-plaintext highlighter-rouge">request</code> 的方法时都会通过 <code class="language-plaintext highlighter-rouge">rootRequeue</code> 进行异步调用，以保证线程安全。 再看一下 <code class="language-plaintext highlighter-rouge">Request</code> 中对应的方法都做了哪些处理：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">didCreateInitialURLRequest</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">dispatchPrecondition</span><span class="p">(</span><span class="nv">condition</span><span class="p">:</span> <span class="o">.</span><span class="nf">onQueue</span><span class="p">(</span><span class="n">underlyingQueue</span><span class="p">))</span>

    <span class="err">$</span><span class="n">mutableState</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">eventMonitor</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="nv">didCreateInitialURLRequest</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Session</code> 中调用 <code class="language-plaintext highlighter-rouge">request</code> 的方法都跟上面的实现类似：</p><ol><li>更新 <code class="language-plaintext highlighter-rouge">request.state</code> ；<li>通过 <code class="language-plaintext highlighter-rouge">eventMonitor</code> 调用相关回调；</ol><p><code class="language-plaintext highlighter-rouge">didCreateURLRequest</code> 则负责创建对应的 <code class="language-plaintext highlighter-rouge">URLSessionTask</code> ，在 <code class="language-plaintext highlighter-rouge">requestTaskMap</code> 中添加对应的记录：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">didCreateURLRequest</span><span class="p">(</span><span class="n">_</span> <span class="nv">urlRequest</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">,</span> <span class="k">for</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">dispatchPrecondition</span><span class="p">(</span><span class="nv">condition</span><span class="p">:</span> <span class="o">.</span><span class="nf">onQueue</span><span class="p">(</span><span class="n">rootQueue</span><span class="p">))</span>

    <span class="n">request</span><span class="o">.</span><span class="nf">didCreateURLRequest</span><span class="p">(</span><span class="n">urlRequest</span><span class="p">)</span>

    <span class="k">guard</span> <span class="o">!</span><span class="n">request</span><span class="o">.</span><span class="n">isCancelled</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

    <span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="nf">task</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">urlRequest</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>
    <span class="n">requestTaskMap</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
    <span class="n">request</span><span class="o">.</span><span class="nf">didCreateTask</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="c1">// 根据 request 的 state 对 task 进行操作</span>
    <span class="nf">updateStatesForTask</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="nv">request</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这里之所以需要根据 <code class="language-plaintext highlighter-rouge">request</code> 的 <code class="language-plaintext highlighter-rouge">state</code> 对 <code class="language-plaintext highlighter-rouge">task</code> 进行操作，是因为当 <code class="language-plaintext highlighter-rouge">request</code> 进行重试时也需要调用这个方法，所以如果是重试，就需要根据 <code class="language-plaintext highlighter-rouge">request</code> 的 <code class="language-plaintext highlighter-rouge">state</code> 来调用 <code class="language-plaintext highlighter-rouge">task</code> 对应的方法：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">updateStatesForTask</span><span class="p">(</span><span class="n">_</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">dispatchPrecondition</span><span class="p">(</span><span class="nv">condition</span><span class="p">:</span> <span class="o">.</span><span class="nf">onQueue</span><span class="p">(</span><span class="n">rootQueue</span><span class="p">))</span>

    <span class="n">request</span><span class="o">.</span><span class="n">withState</span> <span class="p">{</span> <span class="n">state</span> <span class="k">in</span>
        <span class="k">switch</span> <span class="n">state</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="n">initialized</span><span class="p">,</span> <span class="o">.</span><span class="nv">finished</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">resumed</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
            <span class="n">rootQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="nf">didResumeTask</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">suspended</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="nf">suspend</span><span class="p">()</span>
            <span class="n">rootQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="nf">didSuspendTask</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
            <span class="n">task</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="n">rootQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">request</span><span class="o">.</span><span class="nf">didCancelTask</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>至此已经走完了一个 <code class="language-plaintext highlighter-rouge">Request</code> 的创建流程，流程如下图所示：</p><p><img data-proofer-ignore data-src="/media/Generate%20Request.png" alt="Generate Request" /></p><h3 id="响应处理">响应处理</h3><h4 id="进度">进度</h4><p>我们可以通过相关的 <code class="language-plaintext highlighter-rouge">cloures</code> 来设置进度的回调：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kt">AF</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="o">.</span><span class="n">uploadProgress</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">downloadProgress</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="nf">responseDecodable</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="kt">SomeType</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="p">}</span>
</pre></table></code></div></div><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">@discardableResult</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">downloadProgress</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nv">closure</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="kt">ProgressHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="n">mutableState</span><span class="o">.</span><span class="n">downloadProgressHandler</span> <span class="o">=</span> <span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="n">closure</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">queue</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">self</span>
<span class="p">}</span>

<span class="kd">@discardableResult</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">uploadProgress</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nv">closure</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="kt">ProgressHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="n">mutableState</span><span class="o">.</span><span class="n">uploadProgressHandler</span> <span class="o">=</span> <span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="n">closure</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">queue</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">self</span>
<span class="p">}</span>
</pre></table></code></div></div><p>使用 <code class="language-plaintext highlighter-rouge">mutableState</code> 来保存相关的 <code class="language-plaintext highlighter-rouge">uploadProgressHandler</code> 和 <code class="language-plaintext highlighter-rouge">downloadProgressHandler</code> ， <code class="language-plaintext highlighter-rouge">uploadProgressHandler</code> 和 <code class="language-plaintext highlighter-rouge">downloadProgressHandler</code> 只支持设置一个，同时会返回 <code class="language-plaintext highlighter-rouge">Self</code> ，这样就可以进行链式调用。</p><p>在 <code class="language-plaintext highlighter-rouge">SessionDelegate</code> 中，如果有进度更新，就会通过 <code class="language-plaintext highlighter-rouge">stateProvider(session)</code> 获取 <code class="language-plaintext highlighter-rouge">request</code> ，调用 <code class="language-plaintext highlighter-rouge">request</code> 对应的方法进行进度更新：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">// SessionDelegate</span>
<span class="kd">open</span> <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span>
                     <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span>
                     <span class="n">didSendBodyData</span> <span class="nv">bytesSent</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">,</span>
                     <span class="nv">totalBytesSent</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">,</span>
                     <span class="nv">totalBytesExpectedToSend</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eventMonitor</span><span class="p">?</span><span class="o">.</span><span class="nf">urlSession</span><span class="p">(</span><span class="n">session</span><span class="p">,</span>
                             <span class="nv">task</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
                             <span class="nv">didSendBodyData</span><span class="p">:</span> <span class="n">bytesSent</span><span class="p">,</span>
                             <span class="nv">totalBytesSent</span><span class="p">:</span> <span class="n">totalBytesSent</span><span class="p">,</span>
                             <span class="nv">totalBytesExpectedToSend</span><span class="p">:</span> <span class="n">totalBytesExpectedToSend</span><span class="p">)</span>

    <span class="n">stateProvider</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">task</span><span class="p">)?</span><span class="o">.</span><span class="nf">updateUploadProgress</span><span class="p">(</span><span class="nv">totalBytesSent</span><span class="p">:</span> <span class="n">totalBytesSent</span><span class="p">,</span>
                                                            <span class="nv">totalBytesExpectedToSend</span><span class="p">:</span> <span class="n">totalBytesExpectedToSend</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Request</span>
<span class="kd">func</span> <span class="nf">updateUploadProgress</span><span class="p">(</span><span class="nv">totalBytesSent</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">,</span> <span class="nv">totalBytesExpectedToSend</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">uploadProgress</span><span class="o">.</span><span class="n">totalUnitCount</span> <span class="o">=</span> <span class="n">totalBytesExpectedToSend</span>
    <span class="n">uploadProgress</span><span class="o">.</span><span class="n">completedUnitCount</span> <span class="o">=</span> <span class="n">totalBytesSent</span>

    <span class="n">uploadProgressHandler</span><span class="p">?</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">uploadProgressHandler</span><span class="p">?</span><span class="o">.</span><span class="nf">handler</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">uploadProgress</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这些<code class="language-plaintext highlighter-rouge">closure</code> 的配置需要在添加 <code class="language-plaintext highlighter-rouge">response handler</code> 前，因为添加 <code class="language-plaintext highlighter-rouge">response handler</code> 之后， <code class="language-plaintext highlighter-rouge">request</code> 有可能会直接调用 <code class="language-plaintext highlighter-rouge">resume()</code> 方法，导致在更新进度时可能 <code class="language-plaintext highlighter-rouge">uploadProgress</code> 和 <code class="language-plaintext highlighter-rouge">downloadProgress</code> 还没进行配置，错过部分进度更新的回调。</p><h4 id="重定向">重定向</h4><p>Alamofire 提供了一个重定向协议 <code class="language-plaintext highlighter-rouge">RedirectHandler</code> ，提供了以下方法，可以生成新的 <code class="language-plaintext highlighter-rouge">URLRequest</code> ，也可以直接调用 <code class="language-plaintext highlighter-rouge">completion(nil)</code> 来拒绝重定向：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">RedirectHandler</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">task</span><span class="p">(</span><span class="n">_</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span>
              <span class="n">willBeRedirectedTo</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">,</span>
              <span class="k">for</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">,</span>
              <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLRequest</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">redirector</span> <span class="o">=</span> <span class="kt">Redirector</span><span class="p">(</span><span class="nv">behavior</span><span class="p">:</span> <span class="o">.</span><span class="n">follow</span><span class="p">)</span>
<span class="kt">AF</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">redirect</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="n">redirector</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">responseDecodable</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="kt">SomeType</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span> 
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Redirector</code> 为 Alamofire 提供了的一个重定向默认实现，在重定向时根据 <code class="language-plaintext highlighter-rouge">behavior</code> 来判断如何进行重定向的相关操作：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">enum</span> <span class="kt">Behavior</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">follow</span>
    <span class="k">case</span> <span class="n">doNotFollow</span>
    <span class="k">case</span> <span class="nf">modify</span><span class="p">((</span><span class="kt">URLSessionTask</span><span class="p">,</span> <span class="kt">URLRequest</span><span class="p">,</span> <span class="kt">HTTPURLResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span><span class="p">?)</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Redirector</span><span class="p">:</span> <span class="kt">RedirectHandler</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">task</span><span class="p">(</span><span class="n">_</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span>
                     <span class="n">willBeRedirectedTo</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">,</span>
                     <span class="k">for</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">,</span>
                     <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLRequest</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">behavior</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">follow</span><span class="p">:</span>
            <span class="nf">completion</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">doNotFollow</span><span class="p">:</span>
            <span class="nf">completion</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
        <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">modify</span><span class="p">(</span><span class="n">closure</span><span class="p">):</span>
            <span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="nf">closure</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="nf">completion</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在设置完 <code class="language-plaintext highlighter-rouge">redirectHandler</code> 后， <code class="language-plaintext highlighter-rouge">SessionDelegate</code> 中也会调用对应的 <code class="language-plaintext highlighter-rouge">redirectHandler</code> 进行重定向：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">open</span> <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span>
                     <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span>
                     <span class="n">willPerformHTTPRedirection</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">,</span>
                     <span class="n">newRequest</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">,</span>
                     <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLRequest</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eventMonitor</span><span class="p">?</span><span class="o">.</span><span class="nf">urlSession</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span> <span class="nv">willPerformHTTPRedirection</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="nv">newRequest</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="c1">// 获取对应的 redirectHandler ，如果 request 的 redirectHandler 为 nil ，就尝试获取 session 的 redirectHandler</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">redirectHandler</span> <span class="o">=</span> <span class="n">stateProvider</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">task</span><span class="p">)?</span><span class="o">.</span><span class="n">redirectHandler</span> <span class="p">??</span> <span class="n">stateProvider</span><span class="p">?</span><span class="o">.</span><span class="n">redirectHandler</span> <span class="p">{</span>
        <span class="n">redirectHandler</span><span class="o">.</span><span class="nf">task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="nv">willBeRedirectedTo</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="n">completionHandler</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">completionHandler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="自定义缓存">自定义缓存</h4><p>Alamofire 提供了一个自定义协议 <code class="language-plaintext highlighter-rouge">CachedResponseHandler</code> ，用于判断是否需要缓存当前的 HTTP 响应结果，可以生成新的 <code class="language-plaintext highlighter-rouge">CachedURLResponse</code> ，也可以调用 <code class="language-plaintext highlighter-rouge">completion(nil)</code> 来拒绝进行缓存：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">CachedResponseHandler</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">dataTask</span><span class="p">(</span><span class="n">_</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span>
                  <span class="n">willCacheResponse</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">CachedURLResponse</span><span class="p">,</span>
                  <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">CachedURLResponse</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>跟 <code class="language-plaintext highlighter-rouge">RedirectHandler</code> 类似， <code class="language-plaintext highlighter-rouge">ResponseCacher</code> 是 Alamofire 提供的遵循 <code class="language-plaintext highlighter-rouge">CachedResponseHandler</code> 协议的一个类，也是通过 <code class="language-plaintext highlighter-rouge">Behavior</code> 来判断如何实现缓存。</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">open</span> <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span>
                     <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span>
                     <span class="n">willCacheResponse</span> <span class="nv">proposedResponse</span><span class="p">:</span> <span class="kt">CachedURLResponse</span><span class="p">,</span>
                     <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">CachedURLResponse</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eventMonitor</span><span class="p">?</span><span class="o">.</span><span class="nf">urlSession</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="n">dataTask</span><span class="p">,</span> <span class="nv">willCacheResponse</span><span class="p">:</span> <span class="n">proposedResponse</span><span class="p">)</span>
	  <span class="c1">// 获取对应的 cachedResponseHandler ，如果 request 的 cachedResponseHandler 为 nil ，就尝试获取 session 的 cachedResponseHandler</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">handler</span> <span class="o">=</span> <span class="n">stateProvider</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">dataTask</span><span class="p">)?</span><span class="o">.</span><span class="n">cachedResponseHandler</span> <span class="p">??</span> <span class="n">stateProvider</span><span class="p">?</span><span class="o">.</span><span class="n">cachedResponseHandler</span> <span class="p">{</span>
        <span class="n">handler</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="n">dataTask</span><span class="p">,</span> <span class="nv">willCacheResponse</span><span class="p">:</span> <span class="n">proposedResponse</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="n">completionHandler</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">completionHandler</span><span class="p">(</span><span class="n">proposedResponse</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>其它的一些相关配置的实现原理也大致相同，这里不再赘述。</p><h3 id="处理请求结果">处理请求结果</h3><p><code class="language-plaintext highlighter-rouge">Request</code> 处理请求结果的流程：</p><p><img data-proofer-ignore data-src="/media/%E5%93%8D%E5%BA%94%E5%A4%84%E7%90%86.png" alt="响应处理" /></p><p>每个 <code class="language-plaintext highlighter-rouge">ResponseSerializer</code> 完成处理后都会调用 <code class="language-plaintext highlighter-rouge">responseSerializerDidComplete(completion: @escaping () -&gt; Void)</code> ，获取下一个 <code class="language-plaintext highlighter-rouge">nextResponseSerializer()</code> 。</p><p><code class="language-plaintext highlighter-rouge">DataRequest</code> 和 <code class="language-plaintext highlighter-rouge">DownloadRequest</code> 都提供了对结果不做任何序列化操作的方法：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">// DataRequest</span>
<span class="kd">func</span> <span class="nf">response</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">AFDataResponse</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span>

<span class="c1">// DownloadRequest</span>
<span class="kd">func</span> <span class="nf">response</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">AFDownloadResponse</span><span class="o">&lt;</span><span class="kt">URL</span><span class="p">?</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">DataRequest</code> 对应的方法实现：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">response</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">AFDataResponse</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="n">appendResponseSerializer</span> <span class="p">{</span>

        <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="kt">AFResult</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
		  <span class="c1">// 1.</span>
        <span class="k">self</span><span class="o">.</span><span class="n">underlyingQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
            <span class="c1">// 2.</span>
			  <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="kt">DataResponse</span><span class="p">(</span><span class="nv">request</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                                        <span class="nv">response</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                                        <span class="nv">data</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                        <span class="nv">metrics</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
                                        <span class="nv">serializationDuration</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                        <span class="nv">result</span><span class="p">:</span> <span class="n">result</span><span class="p">)</span>

            <span class="k">self</span><span class="o">.</span><span class="n">eventMonitor</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="nv">didParseResponse</span><span class="p">:</span> <span class="n">response</span><span class="p">)</span>
			  <span class="c1">// 3.</span>
            <span class="k">self</span><span class="o">.</span><span class="n">responseSerializerDidComplete</span> <span class="p">{</span> <span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">completionHandler</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">self</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>完成序列化操作后，转换到 <code class="language-plaintext highlighter-rouge">underlyingQueue</code> 中进行处理，因为在进行序列化操作时是在 <code class="language-plaintext highlighter-rouge">serializationQueue</code> 进行处理；<li>生成对应的 <code class="language-plaintext highlighter-rouge">DataResponse</code> ，因为不做任何序列化操作，所以 <code class="language-plaintext highlighter-rouge">serializationDuration</code> 直接设置 0 ；<li>调用 <code class="language-plaintext highlighter-rouge">responseSerializerDidComplete</code> 添加 <code class="language-plaintext highlighter-rouge">completionHandler</code> ；</ol><p>添加 <code class="language-plaintext highlighter-rouge">ResponseSerializer</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">appendResponseSerializer</span><span class="p">(</span><span class="n">_</span> <span class="nv">closure</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">mutableState</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">mutableState</span> <span class="k">in</span>
        <span class="n">mutableState</span><span class="o">.</span><span class="n">responseSerializers</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">closure</span><span class="p">)</span>
        <span class="c1">// 1.</span>
        <span class="k">if</span> <span class="n">mutableState</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">finished</span> <span class="p">{</span>
            <span class="n">mutableState</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">resumed</span>
        <span class="p">}</span>
        <span class="c1">// 2.</span>
        <span class="k">if</span> <span class="n">mutableState</span><span class="o">.</span><span class="n">responseSerializerProcessingFinished</span> <span class="p">{</span>
            <span class="n">underlyingQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="nf">processNextResponseSerializer</span><span class="p">()</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// 3.</span>
        <span class="k">if</span> <span class="n">mutableState</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="nf">canTransitionTo</span><span class="p">(</span><span class="o">.</span><span class="n">resumed</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">underlyingQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="n">startImmediately</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span> <span class="p">}</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>这里之所以把状态由 <code class="language-plaintext highlighter-rouge">.finished</code> 为 <code class="language-plaintext highlighter-rouge">.resumed</code> ，是因为如果 <code class="language-plaintext highlighter-rouge">ResponseSerializer</code> 序列化失败，会重新发送请求，而重新发送请求时会调用 <code class="language-plaintext highlighter-rouge">updateStatesForTask</code> 方法，只有 <code class="language-plaintext highlighter-rouge">request</code> 的状态为 <code class="language-plaintext highlighter-rouge">resumed</code> 时才会调用 <code class="language-plaintext highlighter-rouge">task.resume()</code> ， 所以这里要设置为 <code class="language-plaintext highlighter-rouge">resumed</code> ，使得可以调用 <code class="language-plaintext highlighter-rouge">task.resume()</code> ，重新发送请求；<li>是否已经处理完其它 <code class="language-plaintext highlighter-rouge">ResponseSerializer</code> ，如果已经处理完，则直接开始处理新增的 <code class="language-plaintext highlighter-rouge">ResponseSerializer</code> ；<li>是否需要直接开始进行网络请求；</ol><p>调用下一个 <code class="language-plaintext highlighter-rouge">ResponseSerializer</code> 进行处理，如果所有 <code class="language-plaintext highlighter-rouge">ResponseSerializer</code> 都处理完毕则调用所有的 <code class="language-plaintext highlighter-rouge">completions</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">processNextResponseSerializer</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">responseSerializer</span> <span class="o">=</span> <span class="nf">nextResponseSerializer</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            
            <span class="k">var</span> <span class="nv">completions</span><span class="p">:</span> <span class="p">[()</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="err">$</span><span class="n">mutableState</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">mutableState</span> <span class="k">in</span>
                <span class="n">completions</span> <span class="o">=</span> <span class="n">mutableState</span><span class="o">.</span><span class="n">responseSerializerCompletions</span>
				   <span class="c1">// 1.</span>
                <span class="n">mutableState</span><span class="o">.</span><span class="n">responseSerializers</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>
                <span class="n">mutableState</span><span class="o">.</span><span class="n">responseSerializerCompletions</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">mutableState</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="nf">canTransitionTo</span><span class="p">(</span><span class="o">.</span><span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">mutableState</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">finished</span>
                <span class="p">}</span>

                <span class="n">mutableState</span><span class="o">.</span><span class="n">responseSerializerProcessingFinished</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="n">mutableState</span><span class="o">.</span><span class="n">isFinishing</span> <span class="o">=</span> <span class="kc">false</span>
            <span class="p">}</span>
            <span class="n">completions</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">()</span> <span class="p">}</span>
            <span class="nf">cleanup</span><span class="p">()</span>

            <span class="k">return</span>
        <span class="p">}</span>
		  <span class="c1">// 3.</span>
        <span class="n">serializationQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">responseSerializer</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><ol><li>如果已经完成所有序列化操作，优先移除所有的 <code class="language-plaintext highlighter-rouge">ResponseSerializers</code> 和 <code class="language-plaintext highlighter-rouge">ResponseSerializerCompletions</code> ， 这个 <a href="https://github.com/Alamofire/Alamofire/pull/2778">PR</a> 有提到具体原因；<li>执行所有 <code class="language-plaintext highlighter-rouge">ResponseSerializerCompletions</code> ；<li>如果还有序列化操作未执行，就先执行；</ol><p>获取下一个序列化操作，因为只有完成了序列化操作后才会添加对应的 <code class="language-plaintext highlighter-rouge">ResponseSerializerCompletion</code> ，所以通过 <code class="language-plaintext highlighter-rouge">responseSerializers</code> 和 <code class="language-plaintext highlighter-rouge">responseSerializerCompletions</code> 的 <code class="language-plaintext highlighter-rouge">count</code> 来比较即可知道是否还有序列化操作未处理：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">nextResponseSerializer</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(()</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)?</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">responseSerializer</span><span class="p">:</span> <span class="p">(()</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)?</span>

    <span class="err">$</span><span class="n">mutableState</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">mutableState</span> <span class="k">in</span>
        <span class="k">let</span> <span class="nv">responseSerializerIndex</span> <span class="o">=</span> <span class="n">mutableState</span><span class="o">.</span><span class="n">responseSerializerCompletions</span><span class="o">.</span><span class="n">count</span>

        <span class="k">if</span> <span class="n">responseSerializerIndex</span> <span class="o">&lt;</span> <span class="n">mutableState</span><span class="o">.</span><span class="n">responseSerializers</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
            <span class="n">responseSerializer</span> <span class="o">=</span> <span class="n">mutableState</span><span class="o">.</span><span class="n">responseSerializers</span><span class="p">[</span><span class="n">responseSerializerIndex</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">responseSerializer</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="添加序列化操作">添加序列化操作</h4><p>Alamofire 提供了 <code class="language-plaintext highlighter-rouge">DataResponseSerializerProtocol</code> 和 <code class="language-plaintext highlighter-rouge">DownloadResponseSerializerProtocol</code> 协议，用于添加一些自定义的序列化操作：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">DataResponseSerializerProtocol</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">SerializedObject</span>
    <span class="kd">func</span> <span class="nf">serialize</span><span class="p">(</span><span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">?,</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">?,</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">SerializedObject</span>
<span class="p">}</span>


<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">DownloadResponseSerializerProtocol</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">SerializedObject</span>

    <span class="kd">func</span> <span class="nf">serializeDownload</span><span class="p">(</span><span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">?,</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">?,</span> <span class="nv">fileURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">?,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">SerializedObject</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这两个协议都比较好理解，定义了一个关联类型 <code class="language-plaintext highlighter-rouge">SerializedObject</code> 和一个用于将原始数据转换为 <code class="language-plaintext highlighter-rouge">SerializedObject</code> 的方法。 <code class="language-plaintext highlighter-rouge">DataRequest</code> 提供了以下方法给我们添加自定义的序列化操作：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">func</span> <span class="n">response</span><span class="o">&lt;</span><span class="kt">Serializer</span><span class="p">:</span> <span class="kt">DataResponseSerializerProtocol</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span>
                                                                 <span class="nv">responseSerializer</span><span class="p">:</span> <span class="kt">Serializer</span><span class="p">,</span>
                                                                 <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">AFDataResponse</span><span class="o">&lt;</span><span class="kt">Serializer</span><span class="o">.</span><span class="kt">SerializedObject</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
    <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
    <span class="n">appendResponseSerializer</span> <span class="p">{</span>
        <span class="c1">// 1. 进行序列化转换，记录时间</span>
        <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="kt">ProcessInfo</span><span class="o">.</span><span class="n">processInfo</span><span class="o">.</span><span class="n">systemUptime</span>
        <span class="k">let</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">AFResult</span><span class="o">&lt;</span><span class="kt">Serializer</span><span class="o">.</span><span class="kt">SerializedObject</span><span class="o">&gt;</span> <span class="o">=</span> <span class="kt">Result</span> <span class="p">{</span>
            <span class="k">try</span> <span class="n">responseSerializer</span><span class="o">.</span><span class="nf">serialize</span><span class="p">(</span><span class="nv">request</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                                             <span class="nv">response</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                                             <span class="nv">data</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                             <span class="nv">error</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
        <span class="p">}</span><span class="o">.</span><span class="n">mapError</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
            <span class="n">error</span><span class="o">.</span><span class="nf">asAFError</span><span class="p">(</span><span class="nv">or</span><span class="p">:</span> <span class="o">.</span><span class="nf">responseSerializationFailed</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="o">.</span><span class="nf">customSerializationFailed</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">)))</span>
        <span class="p">}</span>

        <span class="k">let</span> <span class="nv">end</span> <span class="o">=</span> <span class="kt">ProcessInfo</span><span class="o">.</span><span class="n">processInfo</span><span class="o">.</span><span class="n">systemUptime</span>

        <span class="k">self</span><span class="o">.</span><span class="n">underlyingQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
            <span class="c1">// 2. 生成对应的 DataResponse ，调用 eventMonitor 对应的方法</span>
            <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="kt">DataResponse</span><span class="p">(</span><span class="nv">request</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                                        <span class="nv">response</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                                        <span class="nv">data</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                        <span class="nv">metrics</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
                                        <span class="nv">serializationDuration</span><span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
                                        <span class="nv">result</span><span class="p">:</span> <span class="n">result</span><span class="p">)</span>

            <span class="k">self</span><span class="o">.</span><span class="n">eventMonitor</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="nv">didParseResponse</span><span class="p">:</span> <span class="n">response</span><span class="p">)</span>
			   <span class="c1">// 3. 如果没有错误，就调用 completionHandler</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">serializerError</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">failure</span><span class="p">,</span> <span class="k">let</span> <span class="nv">delegate</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">delegate</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">responseSerializerDidComplete</span> <span class="p">{</span> <span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">completionHandler</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
                <span class="k">return</span>
            <span class="p">}</span>
			   <span class="c1">// 4. 判断是否重试</span>
            <span class="n">delegate</span><span class="o">.</span><span class="nf">retryResult</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">dueTo</span><span class="p">:</span> <span class="n">serializerError</span><span class="p">)</span> <span class="p">{</span> <span class="n">retryResult</span> <span class="k">in</span>
                <span class="k">var</span> <span class="nv">didComplete</span><span class="p">:</span> <span class="p">(()</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)?</span>

                <span class="k">defer</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="k">let</span> <span class="nv">didComplete</span> <span class="o">=</span> <span class="n">didComplete</span> <span class="p">{</span>
                        <span class="k">self</span><span class="o">.</span><span class="n">responseSerializerDidComplete</span> <span class="p">{</span> <span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">didComplete</span><span class="p">()</span> <span class="p">}</span> <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">switch</span> <span class="n">retryResult</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">.</span><span class="nv">doNotRetry</span><span class="p">:</span>
                    <span class="n">didComplete</span> <span class="o">=</span> <span class="p">{</span> <span class="nf">completionHandler</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">}</span>

                <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">doNotRetryWithError</span><span class="p">(</span><span class="n">retryError</span><span class="p">):</span>
                    <span class="k">let</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">AFResult</span><span class="o">&lt;</span><span class="kt">Serializer</span><span class="o">.</span><span class="kt">SerializedObject</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">retryError</span><span class="o">.</span><span class="nf">asAFError</span><span class="p">(</span><span class="nv">orFailWith</span><span class="p">:</span> <span class="s">"Received retryError was not already AFError"</span><span class="p">))</span>
                    <span class="c1">// 5. 不进行重试</span>
                    <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="kt">DataResponse</span><span class="p">(</span><span class="nv">request</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                                                <span class="nv">response</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                                                <span class="nv">data</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                <span class="nv">metrics</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
                                                <span class="nv">serializationDuration</span><span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
                                                <span class="nv">result</span><span class="p">:</span> <span class="n">result</span><span class="p">)</span>

                    <span class="n">didComplete</span> <span class="o">=</span> <span class="p">{</span> <span class="nf">completionHandler</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">}</span>

                <span class="k">case</span> <span class="o">.</span><span class="n">retry</span><span class="p">,</span> <span class="o">.</span><span class="nv">retryWithDelay</span><span class="p">:</span>
                    <span class="n">delegate</span><span class="o">.</span><span class="nf">retryRequest</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="nv">withDelay</span><span class="p">:</span> <span class="n">retryResult</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">self</span>
<span class="p">}</span>
</pre></table></code></div></div><p>而 Alamofire 也提供了一些常见的序列化操作给我们使用：</p><ol><li><code class="language-plaintext highlighter-rouge">responseString(queue:encoding:completionHandler:)</code> 通过 <code class="language-plaintext highlighter-rouge">StringResponseSerializer</code> 将 <code class="language-plaintext highlighter-rouge">Data</code> 转换为 <code class="language-plaintext highlighter-rouge">String</code> ；<li><code class="language-plaintext highlighter-rouge">responseJSON(queue:options:completionHandler)</code> 通过 <code class="language-plaintext highlighter-rouge">JSONResponseSerializer(JSONSerialization)</code> 将 <code class="language-plaintext highlighter-rouge">Data</code> 转换为 <code class="language-plaintext highlighter-rouge">JSON</code> 对象；<li><code class="language-plaintext highlighter-rouge">responseDecodable(of:queue:decoder:completionHandler:)</code> 通过 <code class="language-plaintext highlighter-rouge">DecodableResponseSerializer</code> 将 <code class="language-plaintext highlighter-rouge">Data</code> 转换为 <code class="language-plaintext highlighter-rouge">Decodable</code> 对象， <code class="language-plaintext highlighter-rouge">decoder</code> 默认为 <code class="language-plaintext highlighter-rouge">JSONDecoder</code> ；</ol><p>这里也是通过协议来对自动的序列化操作进行抽象。</p><h2 id="networkreachabilitymanager">NetworkReachabilityManager</h2><p><code class="language-plaintext highlighter-rouge">NetworkReachabilityManager</code> 是 Alamofire 提供的用于检测网络状态的工具类。 <code class="language-plaintext highlighter-rouge">NetworkReachabilityManager</code> 只用获取监测网络状态，在设备的网络状态改变时收到通知，不要以此来判断是否可以连接某个 host 或者地址。</p><h3 id="networkreachabilitystatus">NetworkReachabilityStatus</h3><p><code class="language-plaintext highlighter-rouge">NetworkReachabilityManager</code> 首先定义了 <code class="language-plaintext highlighter-rouge">NetworkReachabilityStatus</code> 的 <code class="language-plaintext highlighter-rouge">enum</code> 类型：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">enum</span> <span class="kt">NetworkReachabilityStatus</span> <span class="p">{</span>
    <span class="c1">/// 不确定网络状态</span>
    <span class="k">case</span> <span class="n">unknown</span>
    <span class="c1">/// 无法连接</span>
    <span class="k">case</span> <span class="n">notReachable</span>
    <span class="c1">/// 可以连接，具体类型由 ConnectionType 定义</span>
    <span class="k">case</span> <span class="nf">reachable</span><span class="p">(</span><span class="kt">ConnectionType</span><span class="p">)</span>

    <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">flags</span><span class="p">:</span> <span class="kt">SCNetworkReachabilityFlags</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// isActuallyReachable 为 Alamofire 定义的 extension 属性</span>
        <span class="k">guard</span> <span class="n">flags</span><span class="o">.</span><span class="n">isActuallyReachable</span> <span class="k">else</span> <span class="p">{</span> <span class="k">self</span> <span class="o">=</span> <span class="o">.</span><span class="n">notReachable</span><span class="p">;</span> <span class="k">return</span> <span class="p">}</span>
		  <span class="c1">// 先初始化为 .ethernetOrWiFi ，然后判断是否为蜂窝网络，如果是蜂窝网络再转为 . cellular</span>
        <span class="k">var</span> <span class="nv">networkStatus</span><span class="p">:</span> <span class="kt">NetworkReachabilityStatus</span> <span class="o">=</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">ethernetOrWiFi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flags</span><span class="o">.</span><span class="n">isCellular</span> <span class="p">{</span> <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">cellular</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">self</span> <span class="o">=</span> <span class="n">networkStatus</span>
    <span class="p">}</span>

    <span class="c1">/// 定义可以连接时的网络状态类型</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="kt">ConnectionType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">ethernetOrWiFi</span>
        <span class="k">case</span> <span class="n">cellular</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="mutablestate">MutableState</h3><p><code class="language-plaintext highlighter-rouge">MutableState</code> 为 <code class="language-plaintext highlighter-rouge">NetworkReachabilityManager</code> 一些可变状态的封装：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">MutableState</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">listener</span><span class="p">:</span> <span class="kt">Listener</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">listenerQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">previousStatus</span><span class="p">:</span> <span class="kt">NetworkReachabilityStatus</span><span class="p">?</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">NetworkReachabilityManager</code> 的 <code class="language-plaintext highlighter-rouge">mutableState</code> 属性使用 <code class="language-plaintext highlighter-rouge">@Protected</code> 进行声明，保证线程安全。</p><h3 id="属性">属性</h3><p>监听 0.0.0.0 地址的单例， <code class="language-plaintext highlighter-rouge">listenerQueue</code> 为 <code class="language-plaintext highlighter-rouge">.main</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">let</span> <span class="p">`</span><span class="nv">default</span><span class="p">`</span> <span class="o">=</span> <span class="kt">NetworkReachabilityManager</span><span class="p">()</span>
</pre></table></code></div></div><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c1">/// 当前的网络状态是否可以连接</span>
<span class="kd">open</span> <span class="k">var</span> <span class="nv">isReachable</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span> <span class="k">return</span> <span class="n">isReachableOnCellular</span> <span class="o">||</span> <span class="n">isReachableOnEthernetOrWiFi</span> <span class="p">}</span>

<span class="c1">/// 当前的蜂窝网络是否可用</span>
<span class="c1">/// - 用于判断一些是否推荐执行一些需要高或者低带宽的请求，如视频自动播放</span>
<span class="kd">open</span> <span class="k">var</span> <span class="nv">isReachableOnCellular</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span> <span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">cellular</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">/// 当前的 WiFi 是否可用</span>
<span class="kd">open</span> <span class="k">var</span> <span class="nv">isReachableOnEthernetOrWiFi</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span> <span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">ethernetOrWiFi</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">/// `DispatchQueue` 系统 Reachability的更新 queue.</span>
<span class="kd">public</span> <span class="k">let</span> <span class="nv">reachabilityQueue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"org.alamofire.reachabilityQueue"</span><span class="p">)</span>

<span class="c1">/// 可选的 SCNetworkReachabilityFlags</span>
<span class="kd">open</span> <span class="k">var</span> <span class="nv">flags</span><span class="p">:</span> <span class="kt">SCNetworkReachabilityFlags</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">flags</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilityFlags</span><span class="p">()</span>

    <span class="nf">return</span> <span class="p">(</span><span class="kt">SCNetworkReachabilityGetFlags</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">))</span> <span class="p">?</span> <span class="nv">flags</span> <span class="p">:</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">/// 当前网络状态，使用 Optional 的 map 方法动态生成</span>
<span class="kd">open</span> <span class="k">var</span> <span class="nv">status</span><span class="p">:</span> <span class="kt">NetworkReachabilityStatus</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">flags</span><span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">NetworkReachabilityStatus</span><span class="o">.</span><span class="kd">init</span><span class="p">)</span> <span class="p">??</span> <span class="o">.</span><span class="n">unknown</span>
<span class="p">}</span>

<span class="c1">/// 系统的 `SCNetworkReachability` ，用于发送通知</span>
<span class="kd">private</span> <span class="k">let</span> <span class="nv">reachability</span><span class="p">:</span> <span class="kt">SCNetworkReachability</span>

<span class="c1">/// 线程安全的 `MutableState`</span>
<span class="kd">@Protected</span>
<span class="kd">private</span> <span class="k">var</span> <span class="nv">mutableState</span> <span class="o">=</span> <span class="kt">MutableState</span><span class="p">()</span>
</pre></table></code></div></div><h3 id="初始化">初始化</h3><p><code class="language-plaintext highlighter-rouge">NetworkReachabilityManager</code> 提供了两个 <code class="language-plaintext highlighter-rouge">convenience init?</code> 方法：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>
<span class="c1">// 监听指定 host </span>
<span class="kd">public</span> <span class="kd">convenience</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">host</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">reachability</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilityCreateWithName</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">reachability</span><span class="p">:</span> <span class="n">reachability</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 监听 0.0.0.0 地址</span>
<span class="kd">public</span> <span class="kd">convenience</span> <span class="nf">init</span><span class="p">?()</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">zero</span> <span class="o">=</span> <span class="nf">sockaddr</span><span class="p">()</span>
    <span class="n">zero</span><span class="o">.</span><span class="n">sa_len</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="kt">MemoryLayout</span><span class="o">&lt;</span><span class="n">sockaddr</span><span class="o">&gt;.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">zero</span><span class="o">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="nf">sa_family_t</span><span class="p">(</span><span class="kt">AF_INET</span><span class="p">)</span>
    
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">reachability</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilityCreateWithAddress</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    
    <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">reachability</span><span class="p">:</span> <span class="n">reachability</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 上面两个方法如果成功生成 SCNetworkReachability ，到最后会调用这个方法来进行初始化</span>
<span class="kd">private</span> <span class="nf">init</span><span class="p">(</span><span class="nv">reachability</span><span class="p">:</span> <span class="kt">SCNetworkReachability</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">reachability</span> <span class="o">=</span> <span class="n">reachability</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="流程">流程</h3><p><code class="language-plaintext highlighter-rouge">startListening</code> 添加监听：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="kd">@discardableResult</span>
<span class="kd">open</span> <span class="kd">func</span> <span class="nf">startListening</span><span class="p">(</span><span class="n">onQueue</span> <span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span>
                         <span class="n">onUpdatePerforming</span> <span class="nv">listener</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="kt">Listener</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="nf">stopListening</span><span class="p">()</span>
    <span class="c1">// 修改 mutableState ，这里使用的是 @propertyWrapper 的语法糖，直接访问 projectedValue 也就是 Protected&lt;MutableState&gt;</span>
    <span class="c1">// 这样就可以调用 Protected&lt;MutableState&gt; 的 write 方法</span>
    <span class="err">$</span><span class="n">mutableState</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">state</span> <span class="k">in</span>
        <span class="n">state</span><span class="o">.</span><span class="n">listenerQueue</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="n">state</span><span class="o">.</span><span class="n">listener</span> <span class="o">=</span> <span class="n">listener</span>
    <span class="p">}</span>
    <span class="c1">// 与 SCNetworkReachability 交互，添加 callBack 。</span>
    <span class="k">var</span> <span class="nv">context</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilityContext</span><span class="p">(</span><span class="nv">version</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                               <span class="nv">info</span><span class="p">:</span> <span class="kt">Unmanaged</span><span class="o">.</span><span class="nf">passUnretained</span><span class="p">(</span><span class="k">self</span><span class="p">)</span><span class="o">.</span><span class="nf">toOpaque</span><span class="p">(),</span>
                                               <span class="nv">retain</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
                                               <span class="nv">release</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
                                               <span class="nv">copyDescription</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">callback</span><span class="p">:</span> <span class="kt">SCNetworkReachabilityCallBack</span> <span class="o">=</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">info</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">info</span> <span class="o">=</span> <span class="n">info</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">let</span> <span class="nv">instance</span> <span class="o">=</span> <span class="kt">Unmanaged</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityManager</span><span class="o">&gt;.</span><span class="nf">fromOpaque</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="o">.</span><span class="nf">takeUnretainedValue</span><span class="p">()</span>
        <span class="n">instance</span><span class="o">.</span><span class="nf">notifyListener</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="nv">queueAdded</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilitySetDispatchQueue</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="n">reachabilityQueue</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">callbackAdded</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilitySetCallback</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">)</span>

    <span class="c1">// 因为 SCNetworkReachability 不会在初始化时调用一次 callBack ，所以这里有手动调一下。</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">currentFlags</span> <span class="o">=</span> <span class="n">flags</span> <span class="p">{</span>
        <span class="n">reachabilityQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="nf">notifyListener</span><span class="p">(</span><span class="n">currentFlags</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">callbackAdded</span> <span class="o">&amp;&amp;</span> <span class="n">queueAdded</span>
<span class="p">}</span>
</pre></table></code></div></div><p>由于 <code class="language-plaintext highlighter-rouge">NetworkReachabilityManager.default</code> 获取的是单例，调用 <code class="language-plaintext highlighter-rouge">startListening</code> 会清空之前的 <code class="language-plaintext highlighter-rouge">mutableState</code> ，导致无法调用之前的 <code class="language-plaintext highlighter-rouge">listener</code> ，所以还是使用自己生成的 <code class="language-plaintext highlighter-rouge">NetworkReachabilityManager</code> 比较好，各自管理自己的 <code class="language-plaintext highlighter-rouge">mutableState</code> 。</p><p><code class="language-plaintext highlighter-rouge">notifyListener</code> 网络状态变化时调用，执行对应的 <code class="language-plaintext highlighter-rouge">listener</code> ：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">notifyListener</span><span class="p">(</span><span class="n">_</span> <span class="nv">flags</span><span class="p">:</span> <span class="kt">SCNetworkReachabilityFlags</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">newStatus</span> <span class="o">=</span> <span class="kt">NetworkReachabilityStatus</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

    <span class="err">$</span><span class="n">mutableState</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">state</span> <span class="k">in</span>
		  <span class="c1">// 如果状态相等就不调用 listener </span>
        <span class="k">guard</span> <span class="n">state</span><span class="o">.</span><span class="n">previousStatus</span> <span class="o">!=</span> <span class="n">newStatus</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="n">state</span><span class="o">.</span><span class="n">previousStatus</span> <span class="o">=</span> <span class="n">newStatus</span>

        <span class="k">let</span> <span class="nv">listener</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">listener</span>
        <span class="n">state</span><span class="o">.</span><span class="n">listenerQueue</span><span class="p">?</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">listener</span><span class="p">?(</span><span class="n">newStatus</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">stopListening</code> 停止监听，调用 <code class="language-plaintext highlighter-rouge">SCNetworkReachabilitySetCallback</code> 和 <code class="language-plaintext highlighter-rouge">SCNetworkReachabilitySetDispatchQueue</code> 清空 <code class="language-plaintext highlighter-rouge">reachability</code> ，然后清空 <code class="language-plaintext highlighter-rouge">mutableState</code> 的属性：</p><div lang="swift" class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">open</span> <span class="kd">func</span> <span class="nf">stopListening</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">SCNetworkReachabilitySetCallback</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="kt">SCNetworkReachabilitySetDispatchQueue</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="err">$</span><span class="n">mutableState</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">state</span> <span class="k">in</span>
        <span class="n">state</span><span class="o">.</span><span class="n">listener</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="n">state</span><span class="o">.</span><span class="n">listenerQueue</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="n">state</span><span class="o">.</span><span class="n">previousStatus</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="总结">总结</h3><ol><li>不要通过 <code class="language-plaintext highlighter-rouge">NetworkReachabilityManager</code> 来判断是否应该发送请求；<li>当网络状态切换时，可以考虑重新发送请求；<li>网络状态可以为用户请求失败提供一些更明确的提示；<li>判断用户的网络状态来执行不同的流量策略，如视频的清晰度；</ol><h2 id="最后">最后</h2><p>Alamofire 作为一个使用 <code class="language-plaintext highlighter-rouge">Swift</code> 编写的网络库，提供的发起网络请求接口十分简单，学习成本非常低，有不少值得学习和借鉴的地方：</p><ol><li>使用协议进行抽象；<li>使用 <code class="language-plaintext highlighter-rouge">@propertyWrapper</code> 来实现属性的线程安全；<li>支持链式调用，使用上更加优雅和方便；<li>借用 <code class="language-plaintext highlighter-rouge">extension</code> 来为 <code class="language-plaintext highlighter-rouge">protocol</code> 提供默认的方法实现，从而使得 <code class="language-plaintext highlighter-rouge">protocol</code> 的方法是可选的； ……</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/code/'>Code</a>, <a href='/categories/swift/'>Swift</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="post-tag no-text-decoration" >源码解析</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Alamofire - Dirtmelon&url=https://dirtmelon.github.io/posts/Alamofire/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Alamofire - Dirtmelon&u=https://dirtmelon.github.io/posts/Alamofire/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Alamofire - Dirtmelon&url=https://dirtmelon.github.io/posts/Alamofire/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/iglistkit-first/">IGListKit - 开篇</a><li><a href="/posts/iglistkit-second/">IGListKit 的基石 - IGListSectionController</a><li><a href="/posts/iglistkit-third/">IGListKit 的管理者 - IGListAdapter</a><li><a href="/posts/cocoapods-sync-githooks/">一种使用 CocoaPods 同步 Git hooks 的方案</a><li><a href="/posts/cocoapods-first/">CocoaPods 学习记录 - 官方文档</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">阅读笔记</a> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">源码解析</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/%E7%BF%BB%E8%AF%91/">翻译</a> <a class="post-tag" href="/tags/summary/">summary</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/texture/">Texture</a> <a class="post-tag" href="/tags/cocoapods/">CocoaPods</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Moya/"><div class="card-body"> <span class="timeago small" > Jul 5, 2020 <i class="unloaded">2020-07-05T23:53:07+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Moya</h3><div class="text-muted small"><p> 是什么和为什么 通过 Alamofire 可以对 URLSession 进行封装，使我们不需要过多关注一些琐碎的细节。但是在 Alamofire 的上层，我们可能还需要再做一层封装，这层封装针对于我们的 App ，更接近业务层。 Moya 正是对应的这层封装。 一般来说 App 的网络架构可能如下图所示： 可能看到加入 Moya 后，整个 App 的网络层功能非常清晰， App 不会直...</p></div></div></a></div><div class="card"> <a href="/posts/iglistkit-first/"><div class="card-body"> <span class="timeago small" > Nov 30, 2020 <i class="unloaded">2020-11-30T16:02:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>IGListKit - 开篇</h3><div class="text-muted small"><p> UICollectionView/UITableView 作为一个 iOS 开发者，在日常开发中少不了与 UITableView/UICollectionView 打交道。因为复用池的存在，即使在处理大量数据的情况下，它们仍能保持较低的内存占用，而简单的 DataSource/Delegate 设计方式，可以让我们只需要几行代码就可以完成对 UITableView/UICollectionV...</p></div></div></a></div><div class="card"> <a href="/posts/iglistkit-second/"><div class="card-body"> <span class="timeago small" > Dec 20, 2020 <i class="unloaded">2020-12-20T09:43:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>IGListKit 的基石 - IGListSectionController</h3><div class="text-muted small"><p> IGListSectionController 跟 Object 是一一对应的关系，在 IGListAdapterDataSource 的 listAdapter:sectionControllerForObject: 方法中，会根据不同的 Object 返回不同的 IGListSectionController 。它跟我们日常理解的 UICollectinoView 的 Section ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Swift-and-Pointer/" class="btn btn-outline-primary" prompt="Older"><p>Swift 与指针</p></a> <a href="/posts/Moya/" class="btn btn-outline-primary" prompt="Newer"><p>Moya</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//dirtmelon-github-io.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Alamofire'; this.page.url = 'https://dirtmelon.github.io/posts/Alamofire/'; this.page.identifier = '/posts/Alamofire/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/Dirt_melon">dirtmelon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">阅读笔记</a> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">源码解析</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/%E7%BF%BB%E8%AF%91/">翻译</a> <a class="post-tag" href="/tags/summary/">summary</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/texture/">Texture</a> <a class="post-tag" href="/tags/cocoapods/">CocoaPods</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://dirtmelon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZ7JRH6MFN"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZ7JRH6MFN'); }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script>
